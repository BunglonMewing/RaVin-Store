<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="/favicon.ico" type="image/png">
  <link rel="manifest" href="/site.webmanifest">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RaVin Store - Pusat Download Game Android Gratis</title>
  <meta name="description" content="Temukan dan unduh game Android terbaru dan terpopuler secara gratis di RaVin Store. Jelajahi berbagai kategori game mulai dari aksi, olahraga, strategi, simulasi, hingga balapan. Dapatkan game favoritmu dengan mudah dan cepat.">
  <meta name="keywords" content="download game, game android, apk gratis, ravin store, game gratis, game terbaru, game populer, game aksi, game balapan, game olahraga, game strategi">
  <link rel="canonical" href="https://ravinstore.pages.dev/">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://ravinstore.pages.dev/">
  <meta property="og:title" content="RaVin Store - Pusat Download Game Android Gratis">
  <meta property="og:description" content="Temukan dan unduh game Android terbaru dan terpopuler secara gratis di RaVin Store.">
  <meta property="og:image" content="https://ravinstore.pages.dev/logo.png">
  <meta property="og:site_name" content="RaVin Store">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://ravinstore.pages.dev/">
  <meta name="twitter:title" content="RaVin Store - Pusat Download Game Android Gratis">
  <meta name="twitter:description" content="Temukan dan unduh game Android terbaru dan terpopuler secara gratis di RaVin Store.">
  <meta name="twitter:image" content="https://ravinstore.pages.dev/logo.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#0e4372',
            'primary-dark': '#1e537f',
            'primary-light': '#103c66',
            light: '#ffffff',
            muted: '#cfd6df',
            accent: '#f2f5f9',
            dark: '#2f2f2f',
          }
        }
      }
    }
  </script>

</head>
<body class="bg-primary text-light font-sans overflow-x-hidden">
  <!-- Top bar -->
  <div class="sticky top-0 z-20 flex items-center gap-2.5 p-3 bg-primary">
    <button id="openDrawer" aria-label="Open menu" class="cursor-pointer inline-flex flex-col gap-[5px] p-1.5 rounded-lg border-2 border-white shadow-[inset_0_1px_0_#000] bg-[#0c3a62]">
      <span class="block w-5 h-[2.5px] bg-white rounded-[5px] shadow-[0_1px_0_#000]"></span>
      <span class="block w-5 h-[2.5px] bg-white rounded-[5px] shadow-[0_1px_0_#000]"></span>
      <span class="block w-5 h-[2.5px] bg-white rounded-[5px] shadow-[0_1px_0_#000]"></span>
    </button>
    <div class="flex-1 flex items-center justify-center">
      <div class="flex items-center gap-1.5 bg-white border-[3px] border-black rounded-full py-0.5 px-2.5 max-w-xs w-full shadow-lg">
        <input id="searchInput" type="text" placeholder="Search Game" aria-label="Search Game" class="flex-1 border-none font-bold text-gray-800 outline-none text-base bg-transparent" />
        <button id="searchBtn" aria-label="Cari" class="border-none bg-transparent cursor-pointer flex items-center justify-center">
          <img class="w-2.5 h-2.5 object-contain" src="cari.png" alt="search"/>
        </button>
      </div>
    </div>
    <div class="ml-auto"><img src="icon.png" alt="profile" class="w-12 h-12 rounded-xl block"/></div>
  </div>
  
  <!-- Container -->
  <div class="max-w-6xl mx-auto px-3.5 pb-20 pt-2">
    <h3 class="my-2 mx-1 font-extrabold opacity-95">Recommended for you</h3>

    <div class="flex gap-2.5 items-center my-2 mx-1 flex-wrap">
      <button class="font-extrabold cursor-pointer border-2 border-black rounded-full py-1.5 px-2.5 bg-primary text-accent" data-cat="all">All</button>
      <button class="font-extrabold cursor-pointer border-2 border-black rounded-full py-1.5 px-2.5 bg-accent text-primary" data-cat="Sports">Sports</button>
      <button class="font-extrabold cursor-pointer border-2 border-black rounded-full py-1.5 px-2.5 bg-accent text-primary" data-cat="Action">Action</button>
      <button class="font-extrabold cursor-pointer border-2 border-black rounded-full py-1.5 px-2.5 bg-accent text-primary" data-cat="Strategy">Strategy</button>
      <button class="font-extrabold cursor-pointer border-2 border-black rounded-full py-1.5 px-2.5 bg-accent text-primary" data-cat="Simulation">Simulation</button>
      <button class="font-extrabold cursor-pointer border-2 border-black rounded-full py-1.5 px-2.5 bg-accent text-primary" data-cat="Casual">Casual</button>
      <button class="font-extrabold cursor-pointer border-2 border-black rounded-full py-1.5 px-2.5 bg-accent text-primary" data-cat="Racing">Racing</button>
      <button class="font-extrabold cursor-pointer border-2 border-black rounded-full py-1.5 px-2.5 bg-accent text-primary" data-cat="Max2D">Max2D</button>
    </div>

    <div id="gameGrid" class="grid grid-cols-[repeat(auto-fill,minmax(180px,1fr))] gap-4" aria-live="polite"></div>
    <div id="emptyState" class="opacity-80 text-center my-5" style="display:none">Belum ada game. Upload yang pertama! ðŸŽ®</div>
  </div>

  <!-- Drawer -->
  <div id="backdrop" class="fixed inset-0 bg-black/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-250 ease-in-out z-20"></div>
  <aside id="drawer" class="fixed inset-y-0 left-0 w-[92vw] max-w-[520px] p-[18px] -translate-x-full transition-transform duration-350 ease-in-out z-30 pointer-events-none" aria-hidden="true" aria-label="Main menu">
    <div class="bg-[#3b3b3b] rounded-[26px] p-[18px] shadow-lg border-[3px] border-black h-full relative">
      <button id="closeDrawerBtn" class="absolute top-7 right-7 py-1 px-2.5 text-sm rounded-full cursor-pointer font-extrabold bg-accent text-primary">Close</button>
      <div class="flex gap-[18px] items-center bg-dark rounded-[20px] p-4 border-[3px] border-black">
        <img src="icon.png" alt="JBF logo" class="w-[72px] h-[72px] rounded-[16px]"/>
        <div>
          <h1 class="m-0 font-black tracking-[2px]">Ravin Store</h1>
          <div id="loginState" class="text-sm text-[#d7dee7] mt-2">Not logged in</div>
        </div>
      </div>
      <div class="mt-[18px] flex flex-col gap-4">
        <button id="btnUpload" class="flex items-center gap-3.5 bg-[#5a5a5a] rounded-[22px] p-[18px] border-[3px] border-black cursor-pointer no-underline">
          <img src="game.png" alt="Upload" class="w-[42px] h-[42px] rounded-[10px]"/>
          <span class="font-black text-[22px] text-white" style="text-shadow: 0 2px 0 #000;">Upload Game (Free)</span>
        </button>
        <button id="btnLogin" class="flex items-center gap-3.5 bg-[#5a5a5a] rounded-[22px] p-[18px] border-[3px] border-black cursor-pointer no-underline">
          <img src="google.png" alt="Login" class="w-[42px] h-[42px] rounded-[10px]"/>
          <span id="loginText" class="font-black text-[22px] text-white" style="text-shadow: 0 2px 0 #000;">Login</span>
        </button>
        <a class="flex items-center gap-3.5 bg-[#5a5a5a] rounded-[22px] p-[18px] border-[3px] border-black cursor-pointer no-underline" href="https://youtube.com/@bira_gaming?si=DGz6T4hPHaMqTtZx" target="_blank" rel="noopener noreferrer">
          <img src="logo.png" alt="BIRA GM" class="w-[42px] h-[42px] rounded-[10px]"/>
          <span class="font-black text-[22px] text-white" style="text-shadow: 0 2px 0 #000;">Support Store Creator</span>
        </a>
        <a class="flex items-center gap-3.5 bg-[#5a5a5a] rounded-[22px] p-[18px] border-[3px] border-black cursor-pointer no-underline" href="https://youtube.com/@circledevelop?si=Dz7sOT2jXQZKKTV0" target="_blank" rel="noopener noreferrer">
          <img src="devin.png" alt="BIRA GM" class="w-[42px] h-[42px] rounded-[10px]"/>
          <span class="font-black text-[22px] text-white" style="text-shadow: 0 2px 0 #000;">Support Store Creator</span>
        </a>
      </div>
    </div>
  </aside>

  <!-- Login Dialog -->
  <dialog id="loginDlg" class="border-none rounded-[20px] max-w-[620px] w-[95vw] p-0 bg-accent shadow-lg">
    <div class="flex items-center justify-between p-3.5 bg-primary text-light rounded-t-[20px]">
      <strong class="font-bold">Login / Register</strong>
      <button class="border-none rounded-full py-1 px-2.5 font-extrabold cursor-pointer bg-accent text-primary" onclick="loginDlg.close()">Close</button>
    </div>
    <form id="loginForm" class="p-4 text-[#18212c] max-h-[75vh] overflow-y-auto" method="dialog">
      <div class="grid gap-2 my-2.5">
        <label for="email" class="font-bold">Email</label>
        <input id="email" type="email" required placeholder="you@gmail.com" class="p-2.5 rounded-lg border-2 border-primary outline-none text-[15px]"/>
      </div>
      <div class="grid gap-2 my-2.5">
        <label for="pwd" class="font-bold">Password</label>
        <input id="pwd" type="password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="p-2.5 rounded-lg border-2 border-primary outline-none text-[15px]"/>
      </div>
      <div class="text-xs text-[#4b5b70]">Gunakan akun baru untuk register otomatis; jika sudah ada akan login.</div>
      <div class="flex gap-2.5 justify-end px-4 pb-4 mt-4">
        <button type="button" class="border-none rounded-full py-2.5 px-4 font-extrabold cursor-pointer bg-accent text-primary" onclick="loginDlg.close()">Batal</button>
        <button type="submit" class="border-none rounded-full py-2.5 px-4 font-extrabold cursor-pointer bg-primary text-light">Masuk</button>
      </div>
    </form>
  </dialog>

  <!-- Upload Dialog -->
  <dialog id="uploadDlg" class="border-none rounded-[20px] max-w-[620px] w-[95vw] p-0 bg-accent shadow-lg">
    <div class="flex items-center justify-between p-3.5 bg-primary text-light rounded-t-[20px]">
      <strong class="font-bold">Upload Game</strong>
      <button class="border-none rounded-full py-1 px-2.5 font-extrabold cursor-pointer bg-accent text-primary" onclick="uploadDlg.close()">Close</button>
    </div>
    <form id="uploadForm" class="p-4 text-[#18212c] max-h-[75vh] overflow-y-auto" method="dialog">
      <div class="grid gap-2 my-2.5"><label for="appName" class="font-bold">Nama Game</label><input id="appName" type="text" required placeholder="Contoh: Super Football 23" class="p-2.5 rounded-lg border-2 border-primary outline-none text-[15px]"/></div>
      <div class="grid gap-2 my-2.5"><label for="apkFile" class="font-bold">File Game (APK/ZIP)</label><input id="apkFile" type="file" accept=".apk,.zip,application/vnd.android.package-archive,application/zip" required class="p-2.5 rounded-lg border-2 border-dashed border-primary bg-white"/></div>
      <div class="grid gap-2 my-2.5">
        <label for="iconFile" class="font-bold">Icon APK</label>
        <input id="iconFile" type="file" accept="image/*" required class="p-2.5 rounded-lg border-2 border-dashed border-primary bg-white"/>
      </div>
      <div class="grid gap-2 my-2.5">
        <label for="screenshotsFile" class="font-bold">Screenshots (max 5 images)</label>
        <input id="screenshotsFile" type="file" accept="image/*" multiple class="p-2.5 rounded-lg border-2 border-dashed border-primary bg-white"/>
      </div>

      <div id="uploadProgress" style="display:none;margin-top:10px">
        <progress id="progressBar" value="0" max="100" style="width:100%"></progress>
        <div id="progressText" style="text-align:center; font-weight:bold; margin-top:5px;"></div>
      </div>

      <div id="uploadSuccess" style="display:none;color:green;font-weight:bold;margin-top:10px">
        Sukses!!
      </div>
      <div class="grid gap-2 my-2.5"><label for="category" class="font-bold">Kategori</label>
        <select id="category" required class="p-2.5 rounded-lg border-2 border-primary outline-none text-[15px]">
          <option value="">Pilih kategoriâ€¦</option>
          <option>Sports</option><option>Action</option><option>Strategy</option>
          <option>Simulation</option><option>Casual</option><option>Racing</option>
          <option>Max2D</option>
        </select>
      </div>
      <div class="grid gap-2 my-2.5"><label for="desc" class="font-bold">Deskripsi</label><textarea id="desc" rows="4" placeholder="Tulis deskripsi singkat gameâ€¦" class="p-2.5 rounded-lg border-2 border-primary outline-none text-[15px]"></textarea></div>
      <div class="grid gap-2 my-2.5"><label for="size" class="font-bold">Ukuran file</label><input id="size" type="text" placeholder="mis. 120 MB" class="p-2.5 rounded-lg border-2 border-primary outline-none text-[15px]"/></div>
      <div class="grid gap-2 my-2.5"><label for="version" class="font-bold">Versi</label><input id="version" type="text" placeholder="1.0.0" class="p-2.5 rounded-lg border-2 border-primary outline-none text-[15px]"/></div>
      <div class="flex gap-2.5 justify-end px-4 pb-4 mt-4">
        <button type="button" class="border-none rounded-full py-2.5 px-4 font-extrabold cursor-pointer bg-accent text-primary" onclick="uploadDlg.close()">Batal</button>
        <button type="submit" class="border-none rounded-full py-2.5 px-4 font-extrabold cursor-pointer bg-primary text-light">Kirim</button>
      </div>
    </form>
  </dialog>

  <!-- Game Detail Dialog -->
  <dialog id="gameDetailDlg" class="border-none rounded-[20px] max-w-[620px] w-[95vw] p-0 bg-accent shadow-lg">
    <div class="flex items-center justify-between p-3.5 bg-primary text-light rounded-t-[20px]">
      <strong id="detailTitle" class="font-bold">Game Title</strong>
      <button class="border-none rounded-full py-1 px-2.5 font-extrabold cursor-pointer bg-accent text-primary" onclick="gameDetailDlg.close()">Close</button>
    </div>
    <div id="gameDetailBody" class="p-4 text-[#18212c] max-h-[75vh] overflow-y-auto">
      <!-- Header -->
      <div class="flex gap-4 items-start">
        <img id="detailIcon" src="game.png" alt="Game Icon" class="w-24 h-24 rounded-3xl border-2 border-black object-cover flex-shrink-0"/>
        <div>
          <h2 id="detailTitleHeader" class="m-0 text-2xl text-primary font-bold">Game Title</h2>
          <div id="detailCategory" class="pointer-events-none inline-block mt-1 bg-accent text-primary border-2 border-black rounded-full py-1.5 px-2.5 font-extrabold cursor-pointer">Category</div>
        </div>
      </div>
      <!-- Summary -->
      <div class="flex justify-around text-center my-5 py-2.5 border-y border-[#d1d9e4]">
        <div class="summary-item">
          <strong id="detailRating" class="block text-lg text-primary">N/A</strong>
          <span id="detailRatingCount" class="text-sm text-[#4b5b70]">0 ratings</span>
        </div>
        <div class="summary-item">
          <strong class="block text-lg text-primary"><span id="detailSize">N/A</span></strong>
          <span class="text-sm text-[#4b5b70]">Size</span>
        </div>
        <div class="summary-item">
          <strong id="detailVersion" class="block text-lg text-primary">N/A</strong>
          <span class="text-sm text-[#4b5b70]">Version</span>
        </div>
      </div>
      <!-- Download Action -->
      <div class="flex justify-center my-4">
        <a id="detailDownloadBtn" class="border-none rounded-full py-3 px-6 font-extrabold cursor-pointer bg-primary text-light text-lg" href="#" download>Download</a>
      </div>
      <!-- Description -->
      <h3 class="my-2 mx-1 font-extrabold opacity-95 text-primary">About this game</h3>
      <p id="detailDesc" class="leading-relaxed mb-5">This is the full description of the game...</p>

      <!-- Screenshot Gallery -->
      <div id="screenshot-gallery" class="my-6" style="display:none;">
          <h3 class="my-2 mx-1 font-extrabold opacity-95 text-primary">Screenshots</h3>
          <div id="screenshot-container" class="flex gap-2.5 overflow-x-auto p-1 bg-accent rounded-xl min-h-[120px] items-center">
              <!-- JS will populate this -->
          </div>
      </div>

      <!-- Comments and Rating -->
      <div class="mt-6 pt-4 border-t border-[#d1d9e4]">
        <h3 class="m-0 mb-4 text-primary font-bold">Ratings and reviews</h3>
        <div id="rating-form-container">
          <!-- Rating form will be inserted here by JS -->
        </div>
        <div id="comment-list" class="flex flex-col gap-3.5 max-h-[300px] overflow-y-auto p-2 bg-accent rounded-xl">
          <div class="opacity-80 text-center my-5">No reviews yet.</div>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Tus JS Client for Resumable Uploads -->
  <script src="https://cdn.jsdelivr.net/npm/tus-js-client@latest/dist/tus.min.js"></script>

  <!-- App Script -->
  <script>
    // ====== KONFIGURASI SUPABASE ======
    const SUPABASE_URL = "https://wpoatnvzlvgrpqlkgixp.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indwb2F0bnZ6bHZncnBxbGtnaXhwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NDM1ODEsImV4cCI6MjA3MTQxOTU4MX0.VoJqq_M0jcdn5rkaL2lzbmf07ohnlzwNyC8mLmqb_4E";
    const USE_SIGNED_URLS = true; // true = link download pakai signed URL (kedaluwarsa)
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== UI ELEMENTS ======
    const drawer = document.getElementById('drawer');
    const backdrop = document.getElementById('backdrop');
    const openDrawerBtn = document.getElementById('openDrawer');
    const closeDrawerBtn = document.getElementById('closeDrawerBtn');
    const btnUpload = document.getElementById('btnUpload');
    const btnLogin = document.getElementById('btnLogin');
    const loginText = document.getElementById('loginText');
    const loginStateEl = document.getElementById('loginState');
    const loginDlg = document.getElementById('loginDlg');
    const uploadDlg = document.getElementById('uploadDlg');
    const gameDetailDlg = document.getElementById('gameDetailDlg');
    const grid = document.getElementById('gameGrid');
    const emptyState = document.getElementById('emptyState');

    // ====== DRAWER ======
    function openDrawer() {
      backdrop.classList.remove('opacity-0', 'pointer-events-none');
      backdrop.classList.add('opacity-100', 'pointer-events-auto');
      drawer.classList.remove('-translate-x-full', 'pointer-events-none');
      drawer.classList.add('translate-x-0', 'pointer-events-auto');
      drawer.setAttribute('aria-hidden', 'false');
    }

    function closeDrawer() {
      backdrop.classList.add('opacity-0', 'pointer-events-none');
      backdrop.classList.remove('opacity-100', 'pointer-events-auto');
      drawer.classList.add('-translate-x-full', 'pointer-events-none');
      drawer.classList.remove('translate-x-0', 'pointer-events-auto');
      drawer.setAttribute('aria-hidden', 'true');
    }
    openDrawerBtn.addEventListener('click', openDrawer);
    closeDrawerBtn.addEventListener('click', closeDrawer);
    backdrop.addEventListener('click', closeDrawer);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') { closeDrawer(); loginDlg.close(); uploadDlg.close(); gameDetailDlg.close(); } });

    // ====== AUTH ======
    let currentUser = null;

    function renderLoginState(user) {
      currentUser = user;
      if (user) {
        loginStateEl.textContent = `Logged in as ${user.email}`;
        loginText.textContent = 'Account';
        btnLogin.onclick = async () => {
          if (confirm('Logout dari akun ini?')) {
            await supabase.auth.signOut();
          }
        };
      } else {
        loginStateEl.textContent = 'Not logged in';
        loginText.textContent = 'Login';
        btnLogin.onclick = () => loginDlg.showModal();
      }
    }

    // Listen for auth changes to handle login persistence
    supabase.auth.onAuthStateChange((event, session) => {
      const user = session?.user || null;
      renderLoginState(user);
      if (event === 'SIGNED_IN') {
        loginDlg.close();
        uploadDlg.close();
      }
    });

    // Login/Register sederhana
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const pwd = document.getElementById('pwd').value.trim();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;

      try {
        let { error } = await supabase.auth.signInWithPassword({ email, password: pwd });

        if (error && error.message.includes('Invalid login credentials')) {
          const { error: signUpErr } = await supabase.auth.signUp({
            email,
            password: pwd,
            options: { emailRedirectTo: window.location.origin },
          });
          if (signUpErr) {
            alert('Login/Register gagal: ' + signUpErr.message);
          } else {
            alert('Registrasi berhasil. Cek email Anda untuk verifikasi.');
            loginDlg.close();
          }
        } else if (error) {
          alert('Login/Register gagal: ' + error.message);
        }
      } catch (err) {
        alert('Terjadi kesalahan tak terduga. Coba lagi.');
      } finally {
        submitBtn.disabled = false;
      }
    });

    // ====== RESUMABLE UPLOAD HELPER ======
    async function resumableUpload(file, path, onProgress) {
      const { data: { session } } = await supabase.auth.getSession();
      // Extract project ID from SUPABASE_URL
      const projectId = new URL(SUPABASE_URL).hostname.split('.')[0];

      return new Promise((resolve, reject) => {
        const upload = new tus.Upload(file, {
          endpoint: `${SUPABASE_URL}/storage/v1/upload/resumable`,
          retryDelays: [0, 3000, 5000, 10000, 20000],
          headers: {
            authorization: `Bearer ${session.access_token}`,
            'x-upsert': 'true', // Overwrite existing file
          },
          uploadDataDuringCreation: true,
          removeFingerprintOnSuccess: true,
          metadata: {
            bucketName: 'apks',
            objectName: path,
            contentType: file.type,
            // cacheControl: 3600 // Optional: set cache control
          },
          chunkSize: 6 * 1024 * 1024, // Must be 6MB for Supabase
          onError: (error) => {
            console.error('TUS Error:', error);
            reject(new Error('TUS upload failed: ' + error));
          },
          onProgress: (bytesUploaded, bytesTotal) => {
            if (onProgress) {
              const percentage = ((bytesUploaded / bytesTotal) * 100).toFixed(2);
              onProgress(bytesUploaded, bytesTotal, percentage);
            }
          },
          onSuccess: () => {
            console.log(`Upload successful for ${path}`);
            resolve();
          },
        });

        // Check if there are any previous uploads to continue.
        upload.findPreviousUploads().then((previousUploads) => {
          if (previousUploads.length) {
            upload.resumeFromPreviousUpload(previousUploads[0]);
          }
          // Start the upload
          upload.start();
        });
      });
    }

    // ====== UPLOAD APK ======
    btnUpload.addEventListener('click', () => {
      if (!currentUser) {
        loginDlg.showModal();
      } else {
        uploadDlg.showModal();
      }
    });

    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (!currentUser) {
        alert('Anda harus login untuk mengupload.');
        loginDlg.showModal();
        return;
      }

      const submitBtn = this.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.textContent;
      let iconPath = null;
      let apkPath = null;
      let screenshotPaths = [];

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Mengunggah...';

        const name = document.getElementById('appName').value.trim();
        const category = document.getElementById('category').value;
        const desc = document.getElementById('desc').value.trim();
        const version = document.getElementById('version').value.trim();
        const sizeText = document.getElementById('size').value.trim();
        const gameFile = document.getElementById('apkFile').files[0];
        const iconFile = document.getElementById('iconFile').files[0];
        const screenshotFiles = document.getElementById('screenshotsFile').files;

        if (!gameFile || !iconFile) {
          alert('Harap pilih file game dan file icon.');
          return;
        }
        if (screenshotFiles.length > 5) {
            alert('Anda hanya dapat mengunggah maksimal 5 screenshot.');
            return;
        }

        const gameFileName = gameFile.name.toLowerCase();
        if (!gameFileName.endsWith('.apk') && !gameFileName.endsWith('.zip')) {
          alert('File game harus berekstensi .apk atau .zip');
          return;
        }
        if (gameFile.size > 1024 * 1024 * 1024) { alert('Ukuran file game maksimal adalah 1GB.'); return; }
        if (iconFile.size > 5 * 1024 * 1024) { alert('Ukuran file icon maksimal adalah 5MB.'); return; }

        // Upload icon
        const iconFileExt = iconFile.name.split('.').pop();
        const iconFileId = crypto.randomUUID();
        iconPath = `${currentUser.id}/icon_${iconFileId}.${iconFileExt}`;
        await resumableUpload(iconFile, iconPath);

        // Upload screenshots
        for (const file of screenshotFiles) {
            if (file.size > 5 * 1024 * 1024) throw new Error(`Screenshot ${file.name} terlalu besar (maks 5MB).`);
            const fileExt = file.name.split('.').pop();
            const fileId = crypto.randomUUID();
            const path = `${currentUser.id}/ss_${fileId}.${fileExt}`;
            await resumableUpload(file, path);
            screenshotPaths.push(path);
        }

        // Upload game file
        const gameFileExt = gameFileName.split('.').pop();
        const gameFileId = crypto.randomUUID();
        apkPath = `${currentUser.id}/${gameFileId}.${gameFileExt}`;
        await resumableUpload(gameFile, apkPath, (bytesUploaded, bytesTotal, percentage) => {
            const progress = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            progress.style.display = 'block';
            progressBar.value = percentage;
            progressText.textContent = `${(bytesUploaded / 1024 / 1024).toFixed(2)} MB / ${(bytesTotal / 1024 / 1024).toFixed(2)} MB (${percentage}%)`;
        });

        // Insert game data to DB
        const { error: insErr } = await supabase.from('games').insert({
            title: name, category: category, description: desc, version: version || null,
            size: sizeText || Math.round(gameFile.size / 1024 / 1024) + ' MB',
            apk_path: apkPath, img_url: iconPath, uploaded_by: currentUser.id,
            screenshots: screenshotPaths
        });
        if (insErr) throw new Error('Gagal menyimpan data game: ' + insErr.message);

        const successMessage = document.getElementById('uploadSuccess');
        successMessage.style.display = 'block';
        setTimeout(() => {
            uploadDlg.close();
            this.reset();
            loadGames();
            successMessage.style.display = 'none';
            document.getElementById('uploadProgress').style.display = 'none';
        }, 2000);


      } catch (error) {
        alert(error.message);
        const filesToRemove = [iconPath, apkPath, ...screenshotPaths].filter(p => p !== null);
        if (filesToRemove.length > 0) {
          await supabase.storage.from('apks').remove(filesToRemove);
          console.log('File-file yang gagal diunggah telah dibersihkan.');
        }
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalBtnText;
      }
    });

    // ====== GAME DATA & RENDERING ======
    function getPublicUrl(path) {
      if (!path) return `data:image/svg+xml;charset=UTF-8,%3csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="%23cccccc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"%3e%3crect x="3" y="3" width="18" height="18" rx="2" ry="2"%3e%3c/rect%3e%3ccircle cx="8.5" cy="8.5" r="1.5"%3e%3c/circle%3e%3cpolyline points="21 15 16 10 5 21"%3e%3c/polyline%3e%3c/svg%3e`; // Default image
      return supabase.storage.from('apks').getPublicUrl(path).data.publicUrl;
    }

    async function resolveDownloadUrl(g){
      if (!g || !g.apk_path) return '#';
      const publicUrl = getPublicUrl(g.apk_path);
      if(!USE_SIGNED_URLS) return publicUrl;

      const { data, error } = await supabase.storage.from('apks').createSignedUrl(g.apk_path, 60*60); // 1 jam
      return error ? publicUrl : data.signedUrl;
    }

    function renderStars(rating = 0) {
      const r = Math.round(rating * 2) / 2; // Round to nearest 0.5
      const full = '<span class="text-[#ffc107]">â˜…</span>'.repeat(Math.floor(r));
      const half = r % 1 !== 0 ? '<span class="text-[#ffc107]">Â½</span>' : '';
      const empty = '<span class="text-[#788a9b]">â˜†</span>'.repeat(5 - Math.ceil(r));
      return full + half + empty;
    }

    function gameCardTemplate(g) {
      const thumb = getPublicUrl(g.img_url);
      return `
        <div class="bg-primary-light rounded-2xl p-2.5 shadow-md flex flex-col cursor-pointer border-2 border-[#1a5a96] transition-transform duration-200 ease-in-out hover:-translate-y-1" data-game-id="${g.id}">
          <img class="w-full h-40 object-cover rounded-lg border-2 border-black bg-[#0b2f52]" src="${thumb}" alt="${g.title}" loading="lazy">
          <h4 class="mt-2.5 mb-1 text-base leading-tight whitespace-nowrap overflow-hidden text-ellipsis">${g.title}</h4>
          <div class="text-sm text-muted">${g.category || 'N/A'}</div>
          <div class="text-sm">${renderStars(g.avg_rating)}</div>
        </div>`;
    }

    async function fetchComments(gameId) {
        const { data, error } = await supabase.from('comments')
            .select(`*`)
            .eq('game_id', gameId)
            .order('created_at', { ascending: false });
        if (error) { console.error('Error fetching comments:', error); return []; }
        return data;
    }

    function renderComments(comments) {
        const listEl = document.getElementById('comment-list');
        if (!comments || comments.length === 0) {
            listEl.innerHTML = '<div class="empty">No reviews yet.</div>';
            return;
        }
        listEl.innerHTML = comments.map(c => `
            <div class="comment">
                <div class="avatar">${c.user ? c.user.email.charAt(0).toUpperCase() : 'U'}</div>
                <div class="comment-body">
                    <strong>${c.user ? c.user.email.split('@')[0] : 'User'}</strong>
                    <p>${c.content}</p>
                </div>
            </div>
        `).join('');
    }

    function createRatingForm(gameId, userRating = 0) {
        const container = document.getElementById('rating-form-container');
        container.innerHTML = `
            <form id="rating-form">
                <div class="row">
                    <label>Rate this game</label>
                    <div class="star-rating-input" data-rating="${userRating}">
                        ${[1,2,3,4,5].map(i => `<span class="star" data-value="${i}">â˜…</span>`).join('')}
                    </div>
                </div>
                <div class="row">
                    <label for="comment-text">Write a review</label>
                    <textarea id="comment-text" rows="3" placeholder="Tell others what you think..."></textarea>
                </div>
                <div class="dlg-actions" style="padding:0">
                    <button type="submit" class="btn-pill btn-primary">Submit</button>
                </div>
            </form>`;

        const stars = container.querySelectorAll('.star');

        function highlightStars(rating) {
            stars.forEach(s => s.classList.toggle('selected', s.dataset.value <= rating));
        }

        highlightStars(userRating);

        container.addEventListener('mouseover', e => {
            if (e.target.matches('.star')) highlightStars(e.target.dataset.value);
        });
        container.addEventListener('mouseout', () => {
            highlightStars(container.querySelector('.star-rating-input').dataset.rating);
        });
        container.addEventListener('click', e => {
            if (e.target.matches('.star')) {
                container.querySelector('.star-rating-input').dataset.rating = e.target.dataset.value;
            }
        });

        document.getElementById('rating-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const rating = container.querySelector('.star-rating-input').dataset.rating;
            const content = document.getElementById('comment-text').value.trim();
            const submitBtn = e.target.querySelector('button[type="submit"]');

            if (rating == 0 && !content) {
                alert('Please provide a rating or a comment.');
                return;
            }
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                if (rating > 0) {
                    const { error } = await supabase.from('ratings').upsert({
                        game_id: gameId,
                        user_id: currentUser.id,
                        rating: rating
                    });
                    if (error) throw new Error('Failed to submit rating: ' + error.message);
                }
                if (content) {
                    const { error } = await supabase.from('comments').insert({
                        game_id: gameId,
                        user_id: currentUser.id,
                        content: content
                    });
                    if (error) throw new Error('Failed to submit comment: ' + error.message);
                }
                alert('Thank you for your feedback!');
                document.getElementById('comment-text').value = '';
                // Refresh comments and potentially the game data
                const comments = await fetchComments(gameId);
                renderComments(comments);
                // Optionally, re-fetch game data to update avg rating instantly
                const { data: updatedGame } = await supabase.from('games').select('*').eq('id', gameId).single();
                if (updatedGame) {
                    const idx = window.__ALL_GAMES__.findIndex(g => g.id === gameId);
                    if(idx > -1) window.__ALL_GAMES__[idx] = updatedGame;
                    openDetailDialog(updatedGame); // Re-open to refresh data
                }
            } catch (err) {
                alert(err.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit';
            }
        });
    }

    async function openDetailDialog(game) {
      console.log('Opening detail for game:', game);
      // Reset scroll and clear old content
      document.getElementById('gameDetailBody').scrollTop = 0;
      document.getElementById('comment-list').innerHTML = '<div class="empty">Loading reviews...</div>';
      document.getElementById('rating-form-container').innerHTML = '';

      // Populate basic info
      document.getElementById('detailTitle').textContent = game.title;
      document.getElementById('detailTitleHeader').textContent = game.title;
      document.getElementById('detailIcon').src = getPublicUrl(game.img_url);
      document.getElementById('detailCategory').textContent = game.category;
      document.getElementById('detailVersion').textContent = game.version || 'N/A';
      document.getElementById('detailSize').textContent = game.size || 'N/A';
      document.getElementById('detailDesc').textContent = game.description || 'No description provided.';

      // Populate rating
      document.getElementById('detailRating').innerHTML = game.avg_rating ? `${game.avg_rating.toFixed(1)} â˜…` : 'N/A';
      document.getElementById('detailRatingCount').textContent = `${game.rating_count || 0} ratings`;

      // Render screenshots
      const galleryContainer = document.getElementById('screenshot-gallery');
      const screenshotContainer = document.getElementById('screenshot-container');
      galleryContainer.style.display = 'block'; // Always show the gallery section
      if (game.screenshots && game.screenshots.length > 0) {
          screenshotContainer.innerHTML = game.screenshots.map(path => {
              const url = getPublicUrl(path);
              return `<img src="${url}" alt="game screenshot" loading="lazy" class="h-60 rounded-xl object-cover"/>`;
          }).join('');
      } else {
          screenshotContainer.innerHTML = `<div class="opacity-80 text-center my-5 w-full text-primary">No screenshots available for this game.</div>`;
      }

      const downloadBtn = document.getElementById('detailDownloadBtn');
      downloadBtn.onclick = async (e) => {
          e.preventDefault();
          downloadBtn.textContent = 'Preparing...';
          downloadBtn.style.pointerEvents = 'none';
          const url = await resolveDownloadUrl(game);
          window.location.href = url;
          setTimeout(() => {
            downloadBtn.textContent = 'Download';
            downloadBtn.style.pointerEvents = 'auto';
          }, 1500);
      };

      gameDetailDlg.showModal();

      // Fetch and render comments
      const comments = await fetchComments(game.id);
      renderComments(comments);

      // If user is logged in, show rating form
      if (currentUser) {
          const { data, error } = await supabase.from('ratings')
              .select('rating').eq('game_id', game.id).eq('user_id', currentUser.id).single();
          createRatingForm(game.id, data ? data.rating : 0);
      }
    }

    async function fetchGames(){
      const { data, error } = await supabase.from('games').select('*').order('created_at', { ascending:false });
      if(error){ console.error(error); return []; }
      return data;
    }

    async function renderGames(list){
      if(!list || list.length===0){
        grid.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      emptyState.style.display = 'none';
      grid.innerHTML = list.map(g => gameCardTemplate(g)).join('');
    }

    async function loadGames(){
      const all = await fetchGames();
      window.__ALL_GAMES__ = all; // Cache all games
      await applyFilterAndSearch();
    }

    // ====== EVENT LISTENERS ======
    grid.addEventListener('click', async (e) => {
        const card = e.target.closest('[data-game-id]');
        if (!card) return;

        const gameId = card.dataset.gameId;
        if (!gameId) return;

        const game = (window.__ALL_GAMES__ || []).find(g => g.id == gameId);
        if (!game) return;

        openDetailDialog(game);
    });

    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const pills = Array.from(document.querySelectorAll('[data-cat]'));
    let activeCat = 'all';

    function filterData(){
      const q = (searchInput.value||'').toLowerCase().trim();
      const src = window.__ALL_GAMES__ || [];
      return src.filter(g=>{
        const okCat = activeCat==='all' || (g.category||'').toLowerCase()===activeCat.toLowerCase();
        const txt = `${g.title||''} ${g.category||''} ${g.description||''}`.toLowerCase();
        const okSearch = !q || txt.includes(q);
        return okCat && okSearch;
      });
    }

    async function applyFilterAndSearch(){
      const filtered = filterData();
      await renderGames(filtered);
    }

    searchBtn.addEventListener('click', applyFilterAndSearch);
    searchInput.addEventListener('input', applyFilterAndSearch);
    pills.forEach(p => {
        p.addEventListener('click', () => {
            pills.forEach(x => {
                x.classList.remove('bg-primary', 'text-accent');
                x.classList.add('bg-accent', 'text-primary');
            });
            p.classList.remove('bg-accent', 'text-primary');
            p.classList.add('bg-primary', 'text-accent');
            activeCat = p.dataset.cat;
            applyFilterAndSearch();
        });
    });

    // ====== INISIALISASI ======
    (async function init(){
      await loadGames();
    })();
  </script>
</body>
</html>

