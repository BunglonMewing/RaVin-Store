<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RaVin Store</title>
  <style>
    :root{
      --bg:#0e4372; --bg-2:#1e537f; --ink:#ffffff; --card:#3b3b3b;
      --muted:#cfd6df; --accent:#111; --pill:#2f2f2f;
      --radius:20px; --shadow:0 8px 24px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:var(--bg);color:var(--ink);overflow-x:hidden}

    /* Top bar */
    .topbar{position:sticky;top:0;z-index:20;display:flex;align-items:center;gap:10px;padding:12px 10px;background:var(--bg);}
    .hamburger{cursor:pointer;display:inline-flex;flex-direction:column;gap:5px;padding:6px;border-radius:8px;border:2px solid #fff;box-shadow:0 1px 0 #000 inset;background:#0c3a62}
    .hamburger span{display:block;width:20px;height:2.5px;background:#fff;border-radius:5px;box-shadow:0 1px 0 #000}
    .search-wrap{flex:1;display:flex;align-items:center;justify-content:center}
    .search{display:flex;align-items:center;gap:6px;background:#fff;border:3px solid #000;border-radius:28px;padding:2px 10px;max-width:280px;width:100%;box-shadow:var(--shadow)}
    .search input{flex:1;border:none;font-weight:700;color:#1a1a1a;outline:none;font-size:16px}
    .search button{border:none;background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .search .icon{width:10px;height:10px;object-fit:contain}
    .profile{margin-left:auto}
    .profile img{width:48px;height:48px;border-radius:12px;display:block}

    /* Content */
    .container{padding:8px 14px 80px 14px;max-width:1100px;margin:0 auto}
    .section-title{margin:8px 4px 6px 4px;font-weight:800;opacity:.95}

    /* Controls row (optional filter) */
    .controls{display:flex;gap:10px;align-items:center;margin:8px 4px 12px 4px;flex-wrap:wrap}
    .pill{background:#e9edf3;color:#0d2b48;border:2px solid #000;border-radius:999px;padding:6px 10px;font-weight:800;cursor:pointer}
    .pill.active{background:#0d2b48;color:#e9edf3}

    /* Grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px}
    .card{background:#103c66;border-radius:18px;padding:10px;box-shadow:0 6px 16px rgba(0,0,0,.25);display:flex;flex-direction:column}
    .thumb{width:100%;height:140px;object-fit:cover;border-radius:12px;border:3px solid #000;background:#0b2f52}
    .card h4{margin:10px 0 4px 0;font-size:16px;line-height:1.2}
    .meta{display:flex;gap:8px;align-items:center;font-size:13px;color:#e7edf6;opacity:.9}
    .row-actions{display:flex;gap:8px;margin-top:8px}
    .btn{flex:1;border:none;background:#e9edf3;color:#0d2b48;font-weight:800;border-radius:999px;padding:8px 12px;cursor:pointer;text-align:center}
    .btn.secondary{background:#cfe0f4}
    .empty{opacity:.8;text-align:center;margin:20px 0}

    /* Drawer */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);opacity:0;pointer-events:none;transition:opacity .25s ease;z-index:29}
    .backdrop.show{opacity:1;pointer-events:auto}
    .drawer{position:fixed;inset:0 30% 0 auto;max-width:520px;width:92vw;padding:18px;transform:translateX(-110%);transition:transform .35s ease;z-index:30}
    .drawer.show{transform:translateX(0)}
    .panel{background:var(--card);border-radius:26px;padding:18px;box-shadow:var(--shadow);border:3px solid #000}
    .brand{display:flex;gap:18px;align-items:center;background:#2f2f2f;border-radius:20px;padding:16px;border:3px solid #000}
    .brand img{width:72px;height:72px;border-radius:16px}
    .brand h1{margin:0;font-weight:900;letter-spacing:2px}
    .menu{margin-top:18px;display:flex;flex-direction:column;gap:16px}
    .menu .btnx{display:flex;align-items:center;gap:14px;background:#5a5a5a;border-radius:22px;padding:18px;border:3px solid #000;cursor:pointer}
    .menu .btnx img{width:42px;height:42px;border-radius:10px}
    .menu .btnx span{font-weight:900;font-size:22px;color:#fff;text-shadow:0 2px 0 #000}
    .helper{font-size:13px;color:#d7dee7;margin-top:8px}

    /* Dialogs */
    dialog{border:none;border-radius:20px;max-width:560px;width:95vw;padding:0;background:#f2f5f9;box-shadow:var(--shadow)}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    .dlg-head{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:#0e4372;color:#fff;border-radius:20px 20px 0 0}
    .dlg-body{padding:16px 18px;color:#18212c}
    .row{display:grid;gap:8px;margin:10px 0}
    .row label{font-weight:700}
    .row input[type="text"],.row input[type="email"],.row input[type="password"],.row textarea,.row select{padding:10px 12px;border-radius:10px;border:2px solid #0e4372;outline:none;font-size:15px}
    .row input[type="file"]{padding:10px 12px;border-radius:10px;border:2px dashed #0e4372;background:#fff}
    .dlg-actions{display:flex;gap:10px;justify-content:flex-end;padding:0 18px 18px 18px}
    .btn-pill{border:none;border-radius:999px;padding:10px 16px;font-weight:800;cursor:pointer}
    .btn-primary{background:#0e4372;color:#fff}
    .btn-ghost{background:#e9edf3;color:#0e4372}
    .tiny{font-size:12px;color:#4b5b70}

    @media (max-width:520px){
      .drawer{inset:0;max-width:none;width:100vw}
      .brand img{width:58px;height:58px}
      .menu .btnx span{font-size:20px}
    }
  </style>
</head>
<body>
  <!-- Top bar -->
  <div class="topbar">
    <button id="openDrawer" aria-label="Open menu" class="hamburger">
      <span></span><span></span><span></span>
    </button>
    <div class="search-wrap">
      <div class="search">
        <input id="searchInput" type="text" placeholder="Search Game" aria-label="Search Game" />
        <button id="searchBtn" aria-label="Cari">
          <img class="cari.png" src="cari.png" alt="search"/>
        </button>
      </div>
    </div>
    <div class="profile"><img src="icon.png" alt="profile"/></div>
  </div>
  
  <!-- Container -->
  <div class="container">
    <h3 class="section-title">Recommended for you</h3>

    <div class="controls">
      <button class="pill active" data-cat="all">All</button>
      <button class="pill" data-cat="Sports">Sports</button>
      <button class="pill" data-cat="Action">Action</button>
      <button class="pill" data-cat="Strategy">Strategy</button>
      <button class="pill" data-cat="Simulation">Simulation</button>
      <button class="pill" data-cat="Casual">Casual</button>
      <button class="pill" data-cat="Racing">Racing</button>
    </div>

    <div id="gameGrid" class="grid" aria-live="polite"></div>
    <div id="emptyState" class="empty" style="display:none">Belum ada game. Upload yang pertama! 🎮</div>
  </div>

  <!-- Drawer -->
  <div id="backdrop" class="backdrop"></div>
  <aside id="drawer" class="drawer" aria-hidden="true" aria-label="Main menu">
    <div class="panel">
      <div class="brand">
        <img src="icon.png" alt="JBF logo"/>
        <div>
          <h1>Ravin Store</h1>
          <div id="loginState" class="helper">Not logged in</div>
        </div>
      </div>
      <div class="menu">
        <button id="btnUpload" class="btnx">
          <img src="game.png" alt="Upload"/>
          <span>Upload Game (Free)</span>
        </button>
        <button id="btnLogin" class="btnx">
          <img src="google.png" alt="Login"/>
          <span id="loginText">Login</span>
        </button>
        <a class="btnx" href="https://youtube.com/@bira_gaming?si=DGz6T4hPHaMqTtZx" target="_blank" rel="noopener noreferrer">
          <img src="logo.png" alt="BIRA GM"/>
          <span>Support Store Creator</span>
          </button>
        <a class="btnx" href="https://youtube.com/@circledevelop?si=Dz7sOT2jXQZKKTV0" target="_blank" rel="noopener noreferrer">
          <img src="devin.png" alt="BIRA GM"/>
          <span>Support Store Creator</span>
        </a>
      </div>
    </div>
  </aside>

  <!-- Login Dialog -->
  <dialog id="loginDlg">
    <div class="dlg-head">
      <strong>Login / Register</strong>
      <button class="btn-pill btn-ghost" onclick="loginDlg.close()">Close</button>
    </div>
    <form id="loginForm" class="dlg-body" method="dialog">
      <div class="row">
        <label for="email">Email</label>
        <input id="email" type="email" required placeholder="you@gmail.com"/>
      </div>
      <div class="row">
        <label for="pwd">Password</label>
        <input id="pwd" type="password" required placeholder="••••••••"/>
      </div>
      <div class="tiny">Gunakan akun baru untuk register otomatis; jika sudah ada akan login.</div>
      <div class="dlg-actions">
        <button type="button" class="btn-pill btn-ghost" onclick="loginDlg.close()">Batal</button>
        <button type="submit" class="btn-pill btn-primary">Masuk</button>
      </div>
    </form>
  </dialog>

  <!-- Upload Dialog -->
  <dialog id="uploadDlg">
    <div class="dlg-head">
      <strong>Upload Game</strong>
      <button class="btn-pill btn-ghost" onclick="uploadDlg.close()">Close</button>
    </div>
    <form id="uploadForm" class="dlg-body" method="dialog">
      <div class="row"><label for="appName">Nama APK</label><input id="appName" type="text" required placeholder="Contoh: Super Football 23"/></div>
      <div class="row"><label for="apkFile">File APK</label><input id="apkFile" type="file" accept=".apk,application/vnd.android.package-archive" required/></div>
      <div class="row"><label for="category">Kategori</label>
        <select id="category" required>
          <option value="">Pilih kategori…</option>
          <option>Sports</option><option>Action</option><option>Strategy</option>
          <option>Simulation</option><option>Casual</option><option>Racing</option>
        </select>
      </div>
      <div class="row"><label for="desc">Deskripsi</label><textarea id="desc" rows="4" placeholder="Tulis deskripsi singkat game…"></textarea></div>
      <div class="row"><label for="size">Ukuran file</label><input id="size" type="text" placeholder="mis. 120 MB"/></div>
      <div class="row"><label for="version">Versi</label><input id="version" type="text" placeholder="1.0.0"/></div>
      <div class="dlg-actions">
        <button type="button" class="btn-pill btn-ghost" onclick="uploadDlg.close()">Batal</button>
        <button type="submit" class="btn-pill btn-primary">Kirim</button>
      </div>
    </form>
  </dialog>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- App Script -->
  <script>
    // ====== KONFIGURASI SUPABASE ======
    const SUPABASE_URL = "https://wpoatnvzlvgrpqlkgixp.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indwb2F0bnZ6bHZncnBxbGtnaXhwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NDM1ODEsImV4cCI6MjA3MTQxOTU4MX0.VoJqq_M0jcdn5rkaL2lzbmf07ohnlzwNyC8mLmqb_4E";
    const USE_SIGNED_URLS = false; // true = link download pakai signed URL (kedaluwarsa)
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== UI ELEMENTS ======
    const drawer = document.getElementById('drawer');
    const backdrop = document.getElementById('backdrop');
    const openDrawerBtn = document.getElementById('openDrawer');
    const btnUpload = document.getElementById('btnUpload');
    const btnLogin = document.getElementById('btnLogin');
    const loginText = document.getElementById('loginText');
    const loginStateEl = document.getElementById('loginState');
    const loginDlg = document.getElementById('loginDlg');
    const uploadDlg = document.getElementById('uploadDlg');
    const grid = document.getElementById('gameGrid');
    const emptyState = document.getElementById('emptyState');

    // ====== DRAWER ======
    function openDrawer(){ drawer.classList.add('show'); backdrop.classList.add('show'); drawer.setAttribute('aria-hidden','false'); }
    function closeDrawer(){ drawer.classList.remove('show'); backdrop.classList.remove('show'); drawer.setAttribute('aria-hidden','true'); }
    openDrawerBtn.addEventListener('click', openDrawer);
    backdrop.addEventListener('click', closeDrawer);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') { closeDrawer(); loginDlg.close(); uploadDlg.close(); } });

    // ====== AUTH ======
    let currentUser = null;
    async function loadSession(){
      const { data: { user } } = await supabase.auth.getUser();
      currentUser = user;
      renderLoginState();
    }
    function renderLoginState(){
      if(currentUser){
        loginStateEl.textContent = `Logged in as ${currentUser.email}`;
        loginText.textContent = 'Account';
        btnLogin.onclick = async () => {
          if(confirm('Logout dari akun ini?')){ await supabase.auth.signOut(); currentUser = null; renderLoginState(); }
        };
      } else {
        loginStateEl.textContent = 'Not logged in';
        loginText.textContent = 'Login';
        btnLogin.onclick = ()=> loginDlg.showModal();
      }
    }
    loadSession();

    // Login/Register sederhana
    document.getElementById('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const pwd = document.getElementById('pwd').value.trim();
      // Coba sign in dulu
      let { data: signInData, error: signInErr } = await supabase.auth.signInWithPassword({ email, password: pwd });
      if(signInErr){
        // Jika error, coba sign up (register)
        const { data: signUpData, error: signUpErr } = await supabase.auth.signUp({ email, password: pwd });
        if(signUpErr){ alert('Login/Register gagal: ' + signUpErr.message); return; }
        alert('Registrasi berhasil. Anda sudah login.');
        currentUser = signUpData.user;
      } else {
        currentUser = signInData.user;
      }
      renderLoginState();
      loginDlg.close();
    });

    // ====== UPLOAD APK ======
    btnUpload.addEventListener('click', ()=>{
      if(!currentUser){ loginDlg.showModal(); } else { uploadDlg.showModal(); }
    });

    document.getElementById('uploadForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!currentUser){ loginDlg.showModal(); return; }

      const name = document.getElementById('appName').value.trim();
      const category = document.getElementById('category').value;
      const desc = document.getElementById('desc').value.trim();
      const version = document.getElementById('version').value.trim();
      const sizeText = document.getElementById('size').value.trim();
      const apkFile = document.getElementById('apkFile').files[0];

      if(!apkFile) { alert('Pilih file APK.'); return; }
      if(!apkFile.name.toLowerCase().endsWith('.apk')){
        alert('File harus .apk'); return;
      }
      if(apkFile.size > 1024*1024*1024){ // 1GB
        alert('Maksimum 1GB'); return;
      }

      // Path unik
      const fileId = crypto.randomUUID();
      const path = `${currentUser.id}/${fileId}.apk`;

      // Upload ke bucket 'apks'
      const { data: upData, error: upErr } = await supabase.storage
        .from('apks')
        .upload(path, apkFile, { contentType: 'application/vnd.android.package-archive', upsert: false });

      if(upErr){ alert('Gagal upload: ' + upErr.message); return; }

      // URL download
      let downloadUrl = null;
      if(USE_SIGNED_URLS){
        const { data: signed, error: signErr } = await supabase.storage.from('apks').createSignedUrl(path, 60*60*24); // 24 jam
        if(signErr){ alert('Gagal buat signed URL: ' + signErr.message); return; }
        downloadUrl = signed.signedUrl;
      } else {
        downloadUrl = supabase.storage.from('apks').getPublicUrl(path).data.publicUrl;
      }

      // Simpan metadata ke tabel games
      const { error: insErr } = await supabase
        .from('games')
        .insert({
          title: name,
          category: category,
          description: desc,
          version: version || null,
          size: sizeText || Math.round(apkFile.size/1024/1024)+' MB',
          img_url: null,        // bisa ditambah upload poster kalau mau
          apk_path: path,
          uploaded_by: currentUser.id
        });

      if(insErr){ alert('Gagal simpan metadata: ' + insErr.message); return; }

      alert('Upload sukses! Game tampil di beranda.');
      uploadDlg.close();
      await loadGames();  // refresh list
    });

    // ====== LIST & RENDER GAMES ======
    async function fetchGames(){
      const { data, error } = await supabase
        .from('games')
        .select('*')
        .order('created_at', { ascending:false });
      if(error){ console.error(error); return []; }
      return data;
    }

    function gameCardTemplate(g, urlResolver){
      const thumb = g.img_url || './images/placeholder.jpg';
      const rating = g.rating ? `⭐ ${Number(g.rating).toFixed(1)} • ` : '';
      const resolvedUrl = urlResolver(g);
      return `
        <div class="card">
          <img class="thumb" src="${thumb}" alt="${g.title}">
          <h4>${g.title}</h4>
          <div class="meta">${rating}${g.category} • ${g.size || ''}</div>
          <div class="row-actions">
            <a class="btn" href="${resolvedUrl}" download>Download</a>
            <button class="btn secondary" onclick="alert('Install via file APK di perangkat Anda.')">Info</button>
          </div>
        </div>`;
    }

    async function resolveDownloadUrl(g){
      // Jika bucket public, cukup public URL
      const publicUrl = supabase.storage.from('apks').getPublicUrl(g.apk_path).data.publicUrl;
      if(!USE_SIGNED_URLS) return publicUrl;
      // Jika pakai signed
      const { data, error } = await supabase.storage.from('apks').createSignedUrl(g.apk_path, 60*60); // 1 jam
      return error ? publicUrl : data.signedUrl;
    }

    async function renderGames(list){
      if(!list || list.length===0){
        grid.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      emptyState.style.display = 'none';
      // Build HTML dengan resolving URL (signed/public)
      const parts = [];
      for(const g of list){
        const url = await resolveDownloadUrl(g);
        parts.push(gameCardTemplate(g, ()=>url));
      }
      grid.innerHTML = parts.join('');
    }

    async function loadGames(){
      const all = await fetchGames();
      window.__ALL_GAMES__ = all;
      await applyFilterAndSearch();
    }

    // ====== SEARCH & FILTER ======
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const pills = Array.from(document.querySelectorAll('.pill'));
    let activeCat = 'all';

    function filterData(){
      const q = (searchInput.value||'').toLowerCase().trim();
      const src = window.__ALL_GAMES__ || [];
      return src.filter(g=>{
        const okCat = activeCat==='all' || (g.category||'').toLowerCase()===activeCat.toLowerCase();
        const txt = `${g.title||''} ${g.category||''} ${g.description||''}`.toLowerCase();
        const okSearch = !q || txt.includes(q);
        return okCat && okSearch;
      });
    }

    async function applyFilterAndSearch(){
      const filtered = filterData();
      await renderGames(filtered);
    }

    searchBtn.addEventListener('click', applyFilterAndSearch);
    searchInput.addEventListener('input', applyFilterAndSearch);
    pills.forEach(p=>{
      p.addEventListener('click', ()=>{
        pills.forEach(x=>x.classList.remove('active'));
        p.classList.add('active');
        activeCat = p.dataset.cat;
        applyFilterAndSearch();
      });
    });

    // ====== INISIALISASI ======
    (async function init(){
      await loadSession();
      await loadGames();
    })();
  </script>
</body>
</html>