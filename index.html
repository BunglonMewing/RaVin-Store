<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="/favicon.ico" type="image/png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="google-adsense-account" content="ca-pub-1668518864062720">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RaVin Store - Pusat Download Game Android Gratis</title>
  <meta name="description" content="Temukan dan unduh game Android terbaru dan terpopuler secara gratis di RaVin Store. Jelajahi berbagai kategori game mulai dari aksi, olahraga, strategi, simulasi, hingga balapan. Dapatkan game favoritmu dengan mudah dan cepat.">
  <meta name="keywords" content="download game, game android, apk gratis, RaVin Store Netlify, game gratis, game terbaru, game populer, game aksi, game balapan, game olahraga, game strategi">
  <link rel="canonical" href="https://ravinstore.netlify.app/">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://ravinstore.pages.dev/">
  <meta property="og:title" content="RaVin Store - Pusat Download Game Android Gratis">
  <meta property="og:description" content="Temukan dan unduh game Android terbaru dan terpopuler secara gratis di RaVin Store.">
  <meta property="og:image" content="https://ravinstore.netlify.app/icon.png">
  <meta property="og:site_name" content="RaVin Store">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://ravinstore.netlify.app/">
  <meta name="twitter:title" content="RaVin Store - Pusat Download Game Android Gratis">
  <meta name="twitter:description" content="Temukan dan unduh game Android terbaru dan terpopuler secara gratis di RaVin Store.">
  <meta name="twitter:image" content="https://ravinstore.pages.dev/icon.png">

  <style>
    :root {
      --bg: #0e4372; --bg-2: #1e537f; --ink: #ffffff; --card: #103c66;
      --muted: #cfd6df; --accent: #f2f5f9; --pill: #2f2f2f;
      --radius: 20px; --shadow: 0 8px 24px rgba(0,0,0,.25);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg); color: var(--ink);
      overflow-x: hidden;
    }

    /* Top bar */
    .topbar { position: sticky; top: 0; z-index: 20; display: flex; align-items: center; gap: 10px; padding: 12px 10px; background: var(--bg); }
    .hamburger { cursor: pointer; display: inline-flex; flex-direction: column; gap: 5px; padding: 6px; border-radius: 8px; border: 2px solid #fff; box-shadow: 0 1px 0 #000 inset; background: #0c3a62; }
    .hamburger span { display: block; width: 20px; height: 2.5px; background: #fff; border-radius: 5px; box-shadow: 0 1px 0 #000; }
    .search-wrap { flex: 1; display: flex; align-items: center; justify-content: center; }
    .search { display: flex; align-items: center; gap: 6px; background: #fff; border: 3px solid #000; border-radius: 28px; padding: 2px 10px; max-width: 280px; width: 100%; box-shadow: var(--shadow); }
    .search input { flex: 1; border: none; font-weight: 700; color: #1a1a1a; outline: none; font-size: 16px; }
    .search button { border: none; background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .search .icon { width: 10px; height: 10px; object-fit: contain; }
    .profile { margin-left: auto; }
    .profile img { width: 48px; height: 48px; border-radius: 12px; display: block; }

    /* Content */
    .container { padding: 8px 14px 80px 14px; max-width: 1100px; margin: 0 auto; }
    .section-title { margin: 8px 4px 6px 4px; font-weight: 800; opacity: .95; }

    /* Controls */
    .controls { display: flex; gap: 10px; align-items: center; margin: 8px 4px 12px 4px; flex-wrap: wrap; }
    .pill { background: #e9edf3; color: #0d2b48; border: 2px solid #000; border-radius: 999px; padding: 6px 12px; font-weight: 800; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; }
    .pill svg { width: 1em; height: 1em; }
    .pill.active { background: #0d2b48; color: #e9edf3; }

    /* Grid */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; }
    .card { background: var(--card); border-radius: 16px; padding: 10px; box-shadow: 0 6px 16px rgba(0,0,0,.25); display: flex; flex-direction: column; cursor: pointer; border: 2px solid #1a5a96; transition: transform .2s ease; }
    .card:hover { transform: translateY(-4px); }
    .thumb { width: 100%; height: 160px; object-fit: cover; border-radius: 10px; border: 2px solid #000; background: #0b2f52; }
    .card h4 { margin: 10px 0 4px 0; font-size: 16px; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .meta { font-size: 13px; color: var(--muted); }
    .rating-stars { font-size: 14px; color: #ffc107; }
    .rating-stars .muted { color: #788a9b; }
    .empty { opacity: .8; text-align: center; margin: 20px 0; }

    /* Drawer */
    .backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.45); backdrop-filter: blur(2px); opacity: 0; pointer-events: none; transition: opacity .25s ease; z-index: -1; }
    .backdrop.show { opacity: 1; pointer-events: auto; z-index: 29; }
    .drawer { position: fixed; inset: 0 30% 0 auto; max-width: 520px; width: 92vw; padding: 18px; transform: translateX(-110%); transition: transform .35s ease; z-index: -1; pointer-events: none; }
    .drawer.show { transform: translateX(0); z-index: 30; pointer-events: auto; }
    .drawer.closing { transform: translateX(100vw); }
    .panel { background: #3b3b3b; border-radius: 26px; padding: 18px; box-shadow: var(--shadow); border: 3px solid #000; height: 100%; display: flex; flex-direction: column; }
    .brand { display: flex; gap: 18px; align-items: center; background: #2f2f2f; border-radius: 20px; padding: 16px; border: 3px solid #000; }
    .brand img { width: 72px; height: 72px; border-radius: 16px; }
    .brand h1 { margin: 0; font-weight: 900; letter-spacing: 2px; }
    .menu { margin-top: 18px; display: flex; flex-direction: column; gap: 16px; overflow-y: auto; flex-shrink: 1; }
    .menu .btnx { display: flex; align-items: center; gap: 14px; background: #5a5a5a; border-radius: 22px; padding: 18px; border: 3px solid #000; cursor: pointer; text-decoration: none; }
    .menu .btnx img { width: 42px; height: 42px; border-radius: 10px; }
    .menu .btnx span { font-weight: 900; font-size: 22px; color: #fff; text-shadow: 0 2px 0 #000; }
    .helper { font-size: 13px; color: #d7dee7; margin-top: 8px; }

    /* Dialogs */
    dialog { border: none; border-radius: 20px; max-width: 620px; width: 95vw; padding: 0; background: var(--accent); box-shadow: var(--shadow); }
    dialog::backdrop { background: rgba(0,0,0,.5); }
    .dlg-head { display: flex; align-items: center; justify-content: space-between; padding: 14px 18px; background: var(--bg); color: var(--ink); border-radius: 20px 20px 0 0; }
    .dlg-body { padding: 16px 18px; color: #18212c; max-height: 75vh; overflow-y: auto; }
    .row { display: grid; gap: 8px; margin: 10px 0; }
    .row label { font-weight: 700; }
    .row input[type="text"], .row input[type="email"], .row input[type="password"], .row textarea, .row select { padding: 10px 12px; border-radius: 10px; border: 2px solid var(--bg); outline: none; font-size: 15px; }
    .row input[type="file"] { padding: 10px 12px; border-radius: 10px; border: 2px dashed var(--bg); background: #fff; }
    .dlg-actions { display: flex; gap: 10px; justify-content: flex-end; padding: 0 18px 18px 18px; }
    .btn-pill { border: none; border-radius: 999px; padding: 10px 16px; font-weight: 800; cursor: pointer; }
    .btn-primary { background: var(--bg); color: var(--ink); }
    .btn-ghost { background: #e9edf3; color: var(--bg); }
    .tiny { font-size: 12px; color: #4b5b70; }

    /* Game Detail Dialog */
    .detail-header { display: flex; gap: 16px; align-items: flex-start; }
    #detailIcon { width: 96px; height: 96px; border-radius: 24px; border: 3px solid #000; object-fit: cover; flex-shrink: 0; }
    #detailTitleHeader { margin: 0; font-size: 24px; color: var(--bg); }
    #detailCategory { pointer-events: none; display: inline-block; margin-top: 4px; }
    .detail-summary { display: flex; justify-content: space-around; text-align: center; margin: 20px 0; padding: 10px 0; border-top: 1px solid #d1d9e4; border-bottom: 1px solid #d1d9e4; }
    .summary-item strong { display: block; font-size: 18px; color: var(--bg); }
    .summary-item span { font-size: 13px; color: #4b5b70; }
    .detail-desc { line-height: 1.6; margin-bottom: 20px; }
    .detail-actions { display: flex; justify-content: center; gap: 10px; margin: 16px 0; }
    #detailDownloadBtn, #detailShareBtn { font-size: 18px; padding: 12px 24px; }

    /* Comments & Ratings Section */
    .comments-section { margin-top: 24px; padding-top: 16px; border-top: 1px solid #d1d9e4; }
    .comments-section h3 { margin: 0 0 16px 0; color: var(--bg); }
    #comment-list { display: flex; flex-direction: column; gap: 14px; max-height: 300px; overflow-y: auto; padding: 8px; background: #e9edf3; border-radius: 12px; }
    .comment { display: flex; gap: 12px; }
    .comment .avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--bg); color: var(--ink); display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
    .comment-body { display: flex; flex-direction: column; }
    .comment-body strong { font-size: 15px; }
    .comment-body span { font-size: 12px; color: #4b5b70; }
    .comment-body p { margin: 4px 0 0 0; font-size: 14px; }
    #rating-form { margin-top: 20px; }
    .star-rating-input { display: flex; gap: 4px; font-size: 28px; cursor: pointer; }
    .star-rating-input .star { color: #d1d9e4; }
    .star-rating-input .star:hover, .star-rating-input .star.selected { color: #ffc107; }

    /* Screenshot Gallery */
    .screenshots-section { margin: 24px 0; }
    .screenshot-container { display: flex; gap: 10px; overflow-x: auto; padding: 4px; background: #e9edf3; border-radius: 12px; min-height: 120px; align-items: center; }
    .screenshot-container img { height: 240px; border-radius: 12px; object-fit: cover; }
    .screenshot-container .empty { width: 100%; text-align: center; color: #4b5b70; }


    @media (max-width:520px) {
      .drawer { inset: 0; max-width: none; width: 100vw; }
      .brand img { width: 58px; height: 58px; }
      .menu .btnx span { font-size: 20px; }
      .grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
      .thumb { height: 140px; }
    }
  </style>
</head>
<body>
  <!-- Top bar -->
  <div class="topbar">
    <button id="openDrawer" aria-label="Open menu" class="hamburger">
      <span></span><span></span><span></span>
    </button>
    <div class="search-wrap">
      <div class="search">
        <input id="searchInput" type="text" placeholder="Search Game" aria-label="Search Game" />
        <button id="searchBtn" aria-label="Cari">
          <img class="cari.png" src="cari.png" alt="search"/>
        </button>
      </div>
    </div>
    <div class="profile"><img src="icon.png" alt="profile"/></div>
  </div>
  
  <!-- Container -->
  <div class="container">
    <h3 id="trending" class="section-title">Trending Games</h3>
    <div id="trendingGrid" class="grid" aria-live="polite"></div>

    <h3 class="section-title" style="margin-top: 24px;">Recommended for you</h3>

    <div class="controls">
      <button class="pill active" data-cat="all"><svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M10 4H4v6h6V4Zm10 0h-6v6h6V4ZM10 14H4v6h6v-6Zm10 0h-6v6h6v-6Z"/></svg>All</button>
      <button class="pill" data-cat="Sports"><svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm.71 18.29-3.42-2.12-3.42 2.12 1.3-3.9L4.29 13.83l4.21.35 1.3-3.9 1.3 3.9 4.21-.35-2.88 2.54 1.3 3.9ZM12 6.17l.71.44.71-.44L12 5.3l-.71.44Z"/></svg>Sports</button>
      <button class="pill" data-cat="Action"><svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2a9 9 0 1 0 9 9 9 9 0 0 0-9-9Zm0 16a7 7 0 1 1 7-7 7 7 0 0 1-7 7Z"/><path d="M12 6a1 1 0 0 0-1 1v2a1 1 0 0 0 2 0V7a1 1 0 0 0-1-1Z"/><path d="m16.6 6.1-1.42 1.42a1 1 0 0 0 0 1.41 1 1 0 0 0 1.41 0l1.42-1.42a1 1 0 0 0-1.41-1.41Z"/></svg>Action</button>
      <button class="pill" data-cat="Strategy"><svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2a4 4 0 1 0 4 4 4 4 0 0 0-4-4Zm0 9c-2.21 0-4 1.79-4 4v1h8v-1c0-2.21-1.79-4-4-4Z"/><path d="M4 18h16v2H4z"/></svg>Strategy</button>
      <button class="pill" data-cat="Simulation"><svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M12 2a5 5 0 0 0-5 5v2a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V7a5 5 0 0 0-5-5ZM9 7a3 3 0 0 1 6 0H9Z"/><path d="M4 14h16v2H4z"/></svg>Simulation</button>
      <button class="pill" data-cat="Casual"><svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M20 3H4v10c0 2.21 1.79 4 4 4h6c2.21 0 4-1.79 4-4v-3h2c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2Zm0 5h-2V5h2v3Z"/></svg>Casual</button>
      <button class="pill" data-cat="Racing"><svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M14.4 6H20v8h-5.6l.4-2 .4-2-.4-2-.4-2M14 4h8v12h-8l-1.2-6L14 4m-2 0H4v16h2V10h6V4Z"/></svg>Racing</button>
      <button class="pill" data-cat="Max2D"><svg viewBox='0 0 128 128' xmlns='http://www.w3.org/2000/svg'><path fill='currentColor' d='M 96.75,22.375 C 87.8,22.24 78.78,27.23 73.31,38.41 L 18.44,62.19 L 18.25,62.25 C 8.64,67.49 4,75.88 3.22,84.47 C 2.44,93.06 5.34,101.86 10.44,108.66 C 15.54,115.45 22.92,120.32 31.25,120.5 C 39.58,120.68 48.46,116.01 56.19,104.91 L 56.28,104.81 C 69.71,97.56 82.78,91.81 101.25,83.88 C 110.96,79.6 123.59,70.86 124.25,44.28 C 120.46,32.73 111,24.6 100.66,22.75 C 99.36,22.52 98.06,22.39 96.75,22.375 z'/><g fill='white'><path d='M48,52 h-8 v-8 h-8 v8 h-8 v8 h8 v8 h8 v-8 h8z'/><circle cx='80' cy='52' r='6'/><circle cx='94' cy='45' r='6'/></g></svg>Max2D</button>
    </div>

    <div id="gameGrid" class="grid" aria-live="polite"></div>
    <div id="emptyState" class="empty" style="display:none">Belum ada game. Upload yang pertama! 🎮</div>
  </div>

  <!-- Drawer -->
  <div id="backdrop" class="backdrop"></div>
  <aside id="drawer" class="drawer" aria-hidden="true" aria-label="Main menu">
    <div class="panel">
      <button id="closeDrawerBtn" class="btn-pill btn-ghost" style="position:absolute;top:28px;right:28px;padding:4px 10px;font-size:14px">Close</button>
      <div class="brand">
        <img src="icon.png" alt="Ravin Store logo"/>
        <div>
          <h1>Ravin Store</h1>
          <div id="loginState" class="helper">Not logged in</div>
          <div id="coinState" class="helper" style="display: none; margin-top: 4px; font-size: 16px; align-items: center; display: flex; gap: 6px;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#ffc107" style="width:1.2em; height:1.2em;" aria-hidden="true"><path d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M12,18c-3.31,0-6-2.69-6-6s2.69-6,6-6s6,2.69,6,6 S15.31,18,12,18z M12.5,13.5h-1v-3h1V13.5z M12.5,9.5h-1V8h1V9.5z"/></svg>
            <span id="coinBalance" style="font-weight: bold; color: white;">0</span>
          </div>
        </div>
      </div>
      <div class="menu">
        <a class="btnx" href="#trending" onclick="closeDrawer()">
          <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'><path d='M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6h-6z'/></svg>" alt="Trending"/>
          <span>Trending</span>
        </a>
        <button id="btnUpload" class="btnx">
          <img src="data:image/svg+xml;utf8,<svg viewBox='0 0 128 128' xmlns='http://www.w3.org/2000/svg'><path fill='white' d='M 96.75,22.375 C 87.8,22.24 78.78,27.23 73.31,38.41 L 18.44,62.19 L 18.25,62.25 C 8.64,67.49 4,75.88 3.22,84.47 C 2.44,93.06 5.34,101.86 10.44,108.66 C 15.54,115.45 22.92,120.32 31.25,120.5 C 39.58,120.68 48.46,116.01 56.19,104.91 L 56.28,104.81 C 69.71,97.56 82.78,91.81 101.25,83.88 C 110.96,79.6 123.59,70.86 124.25,44.28 C 120.46,32.73 111,24.6 100.66,22.75 C 99.36,22.52 98.06,22.39 96.75,22.375 z'/><g fill='%23333'><path d='M48,52 h-8 v-8 h-8 v8 h-8 v8 h8 v8 h8 v-8 h8z'/><circle cx='80' cy='52' r='6'/><circle cx='94' cy='45' r='6'/></g></svg>" alt="Upload"/>
          <span>Upload Game (Free)</span>
        </button>
        <button id="btnTopUp" class="btnx">
          <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'><path d='M11 17h2v-4h4v-2h-4V7h-2v4H7v2h4v4zm1 5q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.138T12 2q2.075 0 3.9.788t3.175 2.138q1.35 1.35 2.137 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.137T12 22z'/></svg>" alt="Top Up"/>
          <span>Top Up Koin</span>
        </button>
        <button id="btnLogin" class="btnx">
          <img src="google.png" alt="Login"/>
          <span id="loginText">Login</span>
        </button>
        <a class="btnx" href="https://youtube.com/@bira_gaming?si=DGz6T4hPHaMqTtZx" target="_blank" rel="noopener noreferrer">
          <img src="logo.png" alt="BIRA GM"/>
          <span>Support Store Creator</span>
          </button>
        <a class="btnx" href="https://youtube.com/@circledevelop?si=Dz7sOT2jXQZKKTV0" target="_blank" rel="noopener noreferrer">
          <img src="devin.png" alt="BIRA GM"/>
          <span>Support Store Creator</span>
        </a>
      </div>
    </div>
  </aside>

  <!-- Login Dialog -->
  <dialog id="loginDlg">
    <div class="dlg-head">
      <strong>Login / Register</strong>
      <button class="btn-pill btn-ghost" onclick="loginDlg.close()">Close</button>
    </div>
    <form id="loginForm" class="dlg-body" method="dialog">
      <div class="row">
        <label for="email">Email</label>
        <input id="email" type="email" required placeholder="you@gmail.com"/>
      </div>
      <div class="row">
        <label for="pwd">Password</label>
        <input id="pwd" type="password" required placeholder="••••••••"/>
      </div>
      <div class="tiny">Gunakan akun baru untuk register otomatis; jika sudah ada akan login.</div>
      <div class="dlg-actions">
        <button type="button" class="btn-pill btn-ghost" onclick="loginDlg.close()">Batal</button>
        <button type="submit" class="btn-pill btn-primary">Masuk</button>
      </div>
    </form>
  </dialog>

  <!-- Upload Dialog -->
  <dialog id="uploadDlg">
    <div class="dlg-head">
      <strong>Upload Game</strong>
      <button class="btn-pill btn-ghost" onclick="uploadDlg.close()">Close</button>
    </div>
    <form id="uploadForm" class="dlg-body" method="dialog">
      <div class="row"><label for="appName">Nama Game</label><input id="appName" type="text" required placeholder="Contoh: Super Football 23"/></div>
      <div class="row"><label for="apkFile">File Game (APK/ZIP)</label><input id="apkFile" type="file" accept=".apk,.zip,application/vnd.android.package-archive,application/zip" required/></div>
      <div class="row">
        <label>Icon</label>
        <div style="display: flex; align-items: center; gap: 10px;">
            <img id="iconPreview" src="game.png" alt="Icon Preview" style="width: 64px; height: 64px; border-radius: 12px; object-fit: cover; background: #eee;">
            <button type="button" id="scanBtn" class="btn-pill btn-ghost">Scan from APK</button>
        </div>
        <div id="scanBtnHelp" class="tiny">Click "Scan from APK" after selecting a game file.</div>
      </div>
      <div id="customIconRow" class="row" style="display: none;">
        <label for="customIconFile">Ikon Kustom (opsional untuk ZIP)</label>
        <input id="customIconFile" type="file" accept="image/*" />
        <div class="tiny">Jika tidak ada, ikon default akan digunakan untuk file ZIP.</div>
      </div>
<div class="row">
  <label for="screenshotsFile">Screenshots (max 5 images)</label>
  <input id="screenshotsFile" type="file" accept="image/*" multiple/>
</div>

<div id="uploadProgress" style="display:none;margin-top:10px">
  <progress id="progressBar" value="0" max="100" style="width:100%"></progress>
  <div id="progressText" style="text-align:center; font-weight:bold; margin-top:5px;"></div>
</div>

<div id="uploadSuccess" style="display:none;color:green;font-weight:bold;margin-top:10px">
  Sukses!!
</div>
      <div class="row"><label for="category">Kategori</label>
        <select id="category" required>
          <option value="">Pilih kategori…</option>
          <option>Sports</option><option>Action</option><option>Strategy</option>
          <option>Simulation</option><option>Casual</option><option>Racing</option>
          <option>Max2D</option>
        </select>
      </div>
      <div class="row"><label for="desc">Deskripsi</label><textarea id="desc" rows="4" placeholder="Tulis deskripsi singkat game…"></textarea></div>
      <div class="row"><label for="size">Ukuran file</label><input id="size" type="text" placeholder="mis. 120 MB"/></div>
      <div class="row"><label for="version">Versi</label><input id="version" type="text" placeholder="1.0.0"/></div>
      <div class="row"><label for="price">Harga (Koin)</label><input id="price" type="number" min="0" value="0" placeholder="0 (kosongkan jika gratis)"/></div>
      <div class="dlg-actions">
        <button type="button" class="btn-pill btn-ghost" onclick="uploadDlg.close()">Batal</button>
        <button type="submit" class="btn-pill btn-primary">Kirim</button>
      </div>
    </form>
  </dialog>

  <!-- Game Detail Dialog -->
  <dialog id="gameDetailDlg">
    <div class="dlg-head">
      <strong id="detailTitle">Game Title</strong>
      <button class="btn-pill btn-ghost" onclick="gameDetailDlg.close()">Close</button>
    </div>
    <div id="gameDetailBody" class="dlg-body">
      <!-- Header -->
      <div class="detail-header">
        <img id="detailIcon" src="game.png" alt="Game Icon"/>
        <div>
          <h2 id="detailTitleHeader">Game Title</h2>
          <div id="detailCategory" class="pill">Category</div>
        </div>
      </div>
      <!-- Actions -->
      <div class="detail-actions">
        <a id="detailDownloadBtn" class="btn-pill btn-primary" href="#" download>Download</a>
        <button id="detailShareBtn" class="btn-pill btn-ghost">Share</button>
      </div>
      <!-- Summary -->
      <div class="detail-summary">
        <div class="summary-item">
          <strong id="detailRating">N/A</strong>
          <span id="detailRatingCount">0 ratings</span>
        </div>
        <div class="summary-item">
          <strong id="detailDownloads">0</strong>
          <span>Downloads</span>
        </div>
        <div class="summary-item">
          <strong><span id="detailSize">N/A</span></strong>
          <span>Size</span>
        </div>
        <div class="summary-item">
          <strong id="detailVersion">N/A</strong>
          <span>Version</span>
        </div>
      </div>
      <!-- Description -->
      <h3 class="section-title" style="color:var(--bg)">About this game</h3>
      <p id="detailDesc" class="detail-desc">This is the full description of the game...</p>

      <!-- Screenshot Gallery -->
      <div id="screenshot-gallery" class="screenshots-section" style="display:none;">
          <h3 class="section-title" style="color:var(--bg)">Screenshots</h3>
          <div id="screenshot-container" class="screenshot-container">
              <!-- JS will populate this -->
          </div>
      </div>

      <!-- Comments and Rating -->
      <div class="comments-section">
        <h3>Ratings and reviews</h3>
        <div id="rating-form-container">
          <!-- Rating form will be inserted here by JS -->
        </div>
        <div id="comment-list">
          <div class="empty">No reviews yet.</div>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Profile Dialog -->
  <dialog id="profileDlg">
    <div class="dlg-head">
      <strong>Edit Profile</strong>
      <button class="btn-pill btn-ghost" onclick="profileDlg.close()">Close</button>
    </div>
    <form id="profileForm" class="dlg-body" method="dialog">
      <div class="row">
        <label for="nickname">Nickname</label>
        <input id="nickname" type="text" required placeholder="Your public name"/>
      </div>
      <div class="tiny">This will be displayed on your comments.</div>
      <div class="dlg-actions">
        <button type="button" id="btnLogout" class="btn-pill btn-ghost" style="margin-right: auto;">Logout</button>
        <button type="button" class="btn-pill btn-ghost" onclick="profileDlg.close()">Cancel</button>
        <button type="submit" class="btn-pill btn-primary">Save</button>
      </div>
    </form>
  </dialog>

  <!-- Top Up Dialog -->
  <dialog id="topupDlg">
    <div class="dlg-head">
      <strong>Top Up Koin</strong>
      <button class="btn-pill btn-ghost" onclick="topupDlg.close()">Close</button>
    </div>
    <div class="dlg-body" style="line-height: 1.6;">
      <h3>Cara Top Up</h3>
      <p>Untuk melakukan top up koin, silakan ikuti langkah-langkah berikut:</p>
      <ol>
        <li>Hubungi nomor WhatsApp kami di: <strong><a href="https://wa.me/6285179718957" target="_blank" rel="noopener noreferrer">6285179718957</a></strong></li>
        <li>Sebutkan <strong>email akun</strong> Anda dan jumlah koin yang ingin Anda beli.</li>
        <li>Admin kami akan memberikan instruksi pembayaran lebih lanjut (misalnya, via Dana, GoPay, dll).</li>
        <li>Setelah pembayaran Anda dikonfirmasi, koin akan segera ditambahkan ke akun Anda oleh admin.</li>
      </ol>
      <p style="margin-top: 20px; font-style: italic; font-size: 14px; color: #4b5b70;">Catatan: Proses ini dilakukan secara manual oleh admin dan mungkin memerlukan beberapa waktu. Terima kasih atas pengertian dan kesabaran Anda.</p>
    </div>
  </dialog>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Tus JS Client for Resumable Uploads -->
  <script src="https://cdn.jsdelivr.net/npm/tus-js-client@latest/dist/tus.min.js"></script>

  <!-- JSZip for APK processing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <!-- Browser-compatible APK manifest parser (unused) -->
  <script id="binary-xml-parser"></script>

  <!-- App Script -->
  <script>
    // ====== KONFIGURASI SUPABASE ======
    const SUPABASE_URL = "https://wpoatnvzlvgrpqlkgixp.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indwb2F0bnZ6bHZncnBxbGtnaXhwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NDM1ODEsImV4cCI6MjA3MTQxOTU4MX0.VoJqq_M0jcdn5rkaL2lzbmf07ohnlzwNyC8mLmqb_4E";
    const USE_SIGNED_URLS = true; // true = link download pakai signed URL (kedaluwarsa)
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let extractedIconFile = null;

    // ====== UI ELEMENTS ======
    const topupDlg = document.getElementById('topupDlg');
    const drawer = document.getElementById('drawer');
    const backdrop = document.getElementById('backdrop');
    const openDrawerBtn = document.getElementById('openDrawer');
    const closeDrawerBtn = document.getElementById('closeDrawerBtn');
    const btnUpload = document.getElementById('btnUpload');
    const btnLogin = document.getElementById('btnLogin');
    const loginText = document.getElementById('loginText');
    const loginStateEl = document.getElementById('loginState');
    const loginDlg = document.getElementById('loginDlg');
    const uploadDlg = document.getElementById('uploadDlg');
    const gameDetailDlg = document.getElementById('gameDetailDlg');
    const profileDlg = document.getElementById('profileDlg');
    const grid = document.getElementById('gameGrid');
    const emptyState = document.getElementById('emptyState');

    // ====== DRAWER ======
    function openDrawer(){ drawer.classList.add('show'); backdrop.classList.add('show'); drawer.setAttribute('aria-hidden','false'); }
    function closeDrawer(){
      drawer.classList.add('closing');
      drawer.classList.remove('show');
      backdrop.classList.remove('show');
      drawer.setAttribute('aria-hidden','true');
      setTimeout(() => {
        drawer.classList.remove('closing');
      }, 350);
    }
    openDrawerBtn.addEventListener('click', openDrawer);
    closeDrawerBtn.addEventListener('click', closeDrawer);
    backdrop.addEventListener('click', closeDrawer);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') { closeDrawer(); loginDlg.close(); uploadDlg.close(); gameDetailDlg.close(); profileDlg.close(); } });

    // ====== AUTH ======
    let currentUser = null;
    let userProfile = null;

    async function openProfileEditor() {
      if (!currentUser || !userProfile) return;

      document.getElementById('nickname').value = userProfile.nickname || '';
      profileDlg.showModal();
    }

    async function renderLoginState(user) {
      currentUser = user;
      const coinStateEl = document.getElementById('coinState');
      const coinBalanceEl = document.getElementById('coinBalance');

      if (user) {
        loginStateEl.textContent = `Logged in as ${user.email.split('@')[0]}`;
        loginText.textContent = 'Account';
        btnLogin.onclick = openProfileEditor;

        const { data, error } = await supabase.from('profiles').select('nickname, coins').eq('id', user.id).single();

        if (error && error.code !== 'PGRST116') { // PGRST116 = 'exact-one-row-not-found'
          console.error("Error fetching profile:", error);
        }

        if (data) {
          userProfile = data;
          coinBalanceEl.textContent = data.coins !== null ? data.coins : 0;
          coinStateEl.style.display = 'flex';
        } else {
          // Profile might not exist yet for a new user, handle this case gracefully.
          userProfile = { id: user.id, nickname: '', coins: 0 };
          coinBalanceEl.textContent = 0;
          coinStateEl.style.display = 'flex';
        }

      } else {
        userProfile = null;
        loginStateEl.textContent = 'Not logged in';
        loginText.textContent = 'Login';
        btnLogin.onclick = () => loginDlg.showModal();
        coinStateEl.style.display = 'none';
      }
    }

    // Listen for auth changes to handle login persistence
    supabase.auth.onAuthStateChange(async (event, session) => {
      const user = session?.user || null;
      await renderLoginState(user);
      if (event === 'SIGNED_IN') {
        loginDlg.close();
        uploadDlg.close();
      }
    });

    // Login/Register sederhana
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const newNickname = document.getElementById('nickname').value.trim();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;

      try {
        const { error } = await supabase.from('profiles').upsert({
          id: currentUser.id,
          nickname: newNickname,
          updated_at: new Date().toISOString()
        });
        if (error) throw error;
        alert('Profile updated successfully!');
        profileDlg.close();
      } catch (error) {
        alert('Error updating profile: ' + error.message);
      } finally {
        submitBtn.disabled = false;
      }
    });

    document.getElementById('btnLogout').addEventListener('click', async () => {
      if (confirm('Are you sure you want to logout?')) {
        await supabase.auth.signOut();
        profileDlg.close();
      }
    });

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const pwd = document.getElementById('pwd').value.trim();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;

      try {
        let { error } = await supabase.auth.signInWithPassword({ email, password: pwd });

        if (error && error.message.includes('Invalid login credentials')) {
          const { error: signUpErr } = await supabase.auth.signUp({
            email,
            password: pwd,
            options: { emailRedirectTo: window.location.origin },
          });
          if (signUpErr) {
            alert('Login/Register gagal: ' + signUpErr.message);
          } else {
            alert('Registrasi berhasil. Cek email Anda untuk verifikasi.');
            loginDlg.close();
          }
        } else if (error) {
          alert('Login/Register gagal: ' + error.message);
        }
      } catch (err) {
        alert('Terjadi kesalahan tak terduga. Coba lagi.');
      } finally {
        submitBtn.disabled = false;
      }
    });

    // ====== RESUMABLE UPLOAD HELPER ======
    async function resumableUpload(file, path, onProgress) {
      const { data: { session } } = await supabase.auth.getSession();
      // Extract project ID from SUPABASE_URL
      const projectId = new URL(SUPABASE_URL).hostname.split('.')[0];

      return new Promise((resolve, reject) => {
        const upload = new tus.Upload(file, {
          endpoint: `${SUPABASE_URL}/storage/v1/upload/resumable`,
          retryDelays: [0, 3000, 5000, 10000, 20000],
          headers: {
            authorization: `Bearer ${session.access_token}`,
            'x-upsert': 'true', // Overwrite existing file
          },
          uploadDataDuringCreation: true,
          removeFingerprintOnSuccess: true,
          metadata: {
            bucketName: 'apks',
            objectName: path,
            contentType: file.type,
            // cacheControl: 3600 // Optional: set cache control
          },
          chunkSize: 6 * 1024 * 1024, // Must be 6MB for Supabase
          onError: (error) => {
            console.error('TUS Error:', error);
            reject(new Error('TUS upload failed: ' + error));
          },
          onProgress: (bytesUploaded, bytesTotal) => {
            if (onProgress) {
              const percentage = ((bytesUploaded / bytesTotal) * 100).toFixed(2);
              onProgress(bytesUploaded, bytesTotal, percentage);
            }
          },
          onSuccess: () => {
            console.log(`Upload successful for ${path}`);
            resolve();
          },
        });

        // Check if there are any previous uploads to continue.
        upload.findPreviousUploads().then((previousUploads) => {
          if (previousUploads.length) {
            upload.resumeFromPreviousUpload(previousUploads[0]);
          }
          // Start the upload
          upload.start();
        });
      });
    }

    // ====== UPLOAD APK ======
    btnUpload.addEventListener('click', () => {
      if (!currentUser) {
        loginDlg.showModal();
      } else {
        uploadDlg.showModal();
      }
    });

    document.getElementById('btnTopUp').addEventListener('click', () => {
      topupDlg.showModal();
      closeDrawer();
    });

    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (!currentUser) {
        alert('Anda harus login untuk mengupload.');
        loginDlg.showModal();
        return;
      }

      const submitBtn = this.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.textContent;
      let iconPath = null;
      let apkPath = null;
      let screenshotPaths = [];

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Mengunggah...';

        const name = document.getElementById('appName').value.trim();
        const category = document.getElementById('category').value;
        const desc = document.getElementById('desc').value.trim();
        const version = document.getElementById('version').value.trim();
        const sizeText = document.getElementById('size').value.trim();
        const gameFile = document.getElementById('apkFile').files[0];
        const screenshotFiles = document.getElementById('screenshotsFile').files;
        let iconFile;

        const isZipFile = gameFile && gameFile.name.toLowerCase().endsWith('.zip');

        if (isZipFile) {
            const customIcon = document.getElementById('customIconFile').files[0];
            if (customIcon) {
                iconFile = customIcon;
            } else {
                const response = await fetch(DEFAULT_ZIP_ICON_SVG);
                const blob = await response.blob();
                iconFile = new File([blob], 'zip_icon.svg', { type: 'image/svg+xml' });
            }
        } else {
            iconFile = extractedIconFile;
        }

        if (!gameFile) {
          alert('Harap pilih file game (APK/ZIP).');
          return;
        }
        if (!iconFile) {
          alert('Harap scan icon dari APK atau pilih file APK.');
          return;
        }
        if (screenshotFiles.length > 5) {
            alert('Anda hanya dapat mengunggah maksimal 5 screenshot.');
            return;
        }

        const gameFileName = gameFile.name.toLowerCase();
        if (!gameFileName.endsWith('.apk') && !gameFileName.endsWith('.zip')) {
          alert('File game harus berekstensi .apk atau .zip');
          return;
        }
        if (gameFile.size > 1024 * 1024 * 1024) { alert('Ukuran file game maksimal adalah 1GB.'); return; }
        if (iconFile.size > 5 * 1024 * 1024) { alert('Ukuran file icon maksimal adalah 5MB.'); return; }

        // Upload icon
        const iconFileExt = iconFile.name.split('.').pop() || 'svg';
        const iconFileId = crypto.randomUUID();
        iconPath = `${currentUser.id}/icon_${iconFileId}.${iconFileExt}`;
        await resumableUpload(iconFile, iconPath);

        // Upload screenshots
        for (const file of screenshotFiles) {
            if (file.size > 5 * 1024 * 1024) throw new Error(`Screenshot ${file.name} terlalu besar (maks 5MB).`);
            const fileExt = file.name.split('.').pop();
            const fileId = crypto.randomUUID();
            const path = `${currentUser.id}/ss_${fileId}.${fileExt}`;
            await resumableUpload(file, path);
            screenshotPaths.push(path);
        }

        // Upload game file
        const gameFileExt = gameFileName.split('.').pop();
        const gameFileId = crypto.randomUUID();
        apkPath = `${currentUser.id}/${gameFileId}.${gameFileExt}`;
        await resumableUpload(gameFile, apkPath, (bytesUploaded, bytesTotal, percentage) => {
            const progress = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            progress.style.display = 'block';
            progressBar.value = percentage;
            progressText.textContent = `${(bytesUploaded / 1024 / 1024).toFixed(2)} MB / ${(bytesTotal / 1024 / 1024).toFixed(2)} MB (${percentage}%)`;
        });

        const price = parseInt(document.getElementById('price').value, 10) || 0;
        // Insert game data to DB
        const { error: insErr } = await supabase.from('games').insert({
            title: name, category: category, description: desc, version: version || null,
            size: sizeText || Math.round(gameFile.size / 1024 / 1024) + ' MB',
            apk_path: apkPath, img_url: iconPath, uploaded_by: currentUser.id,
            screenshots: screenshotPaths,
            price: price
        });
        if (insErr) throw new Error('Gagal menyimpan data game: ' + insErr.message);

        const successMessage = document.getElementById('uploadSuccess');
        successMessage.style.display = 'block';
        setTimeout(() => {
            uploadDlg.close();
            this.reset();
            loadGames();
            successMessage.style.display = 'none';
            document.getElementById('uploadProgress').style.display = 'none';
        }, 2000);


      } catch (error) {
        alert(error.message);
        const filesToRemove = [iconPath, apkPath, ...screenshotPaths].filter(p => p !== null);
        if (filesToRemove.length > 0) {
          await supabase.storage.from('apks').remove(filesToRemove);
          console.log('File-file yang gagal diunggah telah dibersihkan.');
        }
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalBtnText;
      }
    });

    // ====== GAME DATA & RENDERING ======
    window.signedUrlCache = new Map(); // Cache untuk signed URLs

    async function createSignedImageUrl(path) {
      const defaultIcon = "game.png"; // A local, reliable default
      if (!path) return defaultIcon;

      // Use cache to avoid re-generating URLs for the same path
      if (window.signedUrlCache.has(path)) {
        return window.signedUrlCache.get(path);
      }

      let url = defaultIcon;

      // Respect the global flag for using signed URLs
      if (USE_SIGNED_URLS) {
        const { data, error } = await supabase.storage.from('apks').createSignedUrl(path, 3600); // 1-hour expiry
        if (error) {
          console.error(`Error creating signed URL for "${path}". It might be a private object in a public bucket or a wrong path. Falling back to public URL.`, error.message);
          // Fallback attempt
          const { data: publicUrlData } = supabase.storage.from('apks').getPublicUrl(path);
          url = publicUrlData ? publicUrlData.publicUrl : defaultIcon;
        } else {
          url = data.signedUrl;
        }
      } else {
        // Directly get public URL if signed URLs are disabled
        const { data: publicUrlData } = supabase.storage.from('apks').getPublicUrl(path);
        url = publicUrlData ? publicUrlData.publicUrl : defaultIcon;
      }

      window.signedUrlCache.set(path, url);
      return url;
    }

    async function resolveDownloadUrl(g){
      if (!g || !g.apk_path) return '#';

      // Jika tidak pakai signed URL, coba pakai public URL (asumsi bucket public)
      if(!USE_SIGNED_URLS) {
        return supabase.storage.from('apks').getPublicUrl(g.apk_path).data.publicUrl;
      }

      // Gunakan signed URL untuk download
      const { data, error } = await supabase.storage.from('apks').createSignedUrl(g.apk_path, 60*60); // 1 jam
      if (error) {
        // Fallback ke public URL jika gagal membuat signed URL
        return supabase.storage.from('apks').getPublicUrl(g.apk_path).data.publicUrl;
      }
      return data.signedUrl;
    }

    function calculateRating(game) {
      // First, check for pre-calculated values from the DB (if migration was run)
      if (game.avg_rating !== null && game.avg_rating !== undefined && game.rating_count !== null && game.rating_count !== undefined) {
        return { avg: game.avg_rating, count: game.rating_count };
      }

      // If not, calculate from the fetched ratings array
      if (!game.ratings || game.ratings.length === 0) {
        return { avg: 0, count: 0 };
      }

      const total = game.ratings.reduce((acc, r) => acc + r.rating, 0);
      const avg = total / game.ratings.length;
      return { avg: avg, count: game.ratings.length };
    }

    function renderStars(rating = 0) {
      const r = Math.round(rating * 2) / 2; // Round to nearest 0.5
      const full = '<span class="star">★</span>'.repeat(Math.floor(r));
      const half = r % 1 !== 0 ? '<span class="star">½</span>' : '';
      const empty = '<span class="star muted">☆</span>'.repeat(5 - Math.ceil(r));
      return full + half + empty;
    }

    function gameCardTemplate(g, thumbnailUrl) {
      const ratingInfo = calculateRating(g);
      return `
        <div class="card" data-game-id="${g.id}">
          <img class="thumb" src="${thumbnailUrl}" alt="${g.title}" loading="lazy">
          <h4>${g.title}</h4>
          <div class="meta">${g.category || 'N/A'}</div>
          <div class="rating-stars">${renderStars(ratingInfo.avg)}</div>
        </div>`;
    }

    async function fetchComments(gameId) {
        const { data, error } = await supabase.from('comments')
            .select(`
                *,
                profile:profiles(nickname)
            `)
            .eq('game_id', gameId)
            .order('created_at', { ascending: false });
        if (error) { console.error('Error fetching comments:', error); return []; }
        return data;
    }

    function renderComments(comments) {
        const listEl = document.getElementById('comment-list');
        if (!comments || comments.length === 0) {
            listEl.innerHTML = '<div class="empty">No reviews yet.</div>';
            return;
        }
        listEl.innerHTML = comments.map(c => {
          const authorName = c.profile?.nickname || (c.user ? c.user.email.split('@')[0] : 'User');
          const avatarChar = authorName.charAt(0).toUpperCase();
          return `
            <div class="comment">
                <div class="avatar">${avatarChar}</div>
                <div class="comment-body">
                    <strong>${authorName}</strong>
                    <p>${c.content}</p>
                </div>
            </div>
          `
        }).join('');
    }

    function createRatingForm(gameId, userRating = 0) {
        const container = document.getElementById('rating-form-container');
        container.innerHTML = `
            <form id="rating-form">
                <div class="row">
                    <label>Rate this game</label>
                    <div class="star-rating-input" data-rating="${userRating}">
                        ${[1,2,3,4,5].map(i => `<span class="star" data-value="${i}">★</span>`).join('')}
                    </div>
                </div>
                <div class="row">
                    <label for="comment-text">Write a review</label>
                    <textarea id="comment-text" rows="3" placeholder="Tell others what you think..."></textarea>
                </div>
                <div class="dlg-actions" style="padding:0">
                    <button type="submit" class="btn-pill btn-primary">Submit</button>
                </div>
            </form>`;

        const stars = container.querySelectorAll('.star');

        function highlightStars(rating) {
            stars.forEach(s => s.classList.toggle('selected', s.dataset.value <= rating));
        }

        highlightStars(userRating);

        container.addEventListener('mouseover', e => {
            if (e.target.matches('.star')) highlightStars(e.target.dataset.value);
        });
        container.addEventListener('mouseout', () => {
            highlightStars(container.querySelector('.star-rating-input').dataset.rating);
        });
        container.addEventListener('click', e => {
            if (e.target.matches('.star')) {
                container.querySelector('.star-rating-input').dataset.rating = e.target.dataset.value;
            }
        });

        document.getElementById('rating-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const rating = container.querySelector('.star-rating-input').dataset.rating;
            const content = document.getElementById('comment-text').value.trim();
            const submitBtn = e.target.querySelector('button[type="submit"]');

            if (rating == 0 && !content) {
                alert('Please provide a rating or a comment.');
                return;
            }
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                if (rating > 0) {
                    const { error } = await supabase.from('ratings').upsert({
                        game_id: gameId,
                        user_id: currentUser.id,
                        rating: rating
                    });
                    if (error) throw new Error('Failed to submit rating: ' + error.message);
                }
                if (content) {
                    const { error } = await supabase.from('comments').insert({
                        game_id: gameId,
                        user_id: currentUser.id,
                        content: content
                    });
                    if (error) throw new Error('Failed to submit comment: ' + error.message);
                }
                alert('Thank you for your feedback!');
                document.getElementById('comment-text').value = '';
                // Refresh comments and potentially the game data
                const comments = await fetchComments(gameId);
                renderComments(comments);
                // Optionally, re-fetch game data to update avg rating instantly
                const { data: updatedGame } = await supabase.from('games').select('*').eq('id', gameId).single();
                if (updatedGame) {
                    const idx = window.__ALL_GAMES__.findIndex(g => g.id === gameId);
                    if(idx > -1) window.__ALL_GAMES__[idx] = updatedGame;
                    openDetailDialog(updatedGame); // Re-open to refresh data
                }
            } catch (err) {
                alert(err.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit';
            }
        });
    }

    async function openDetailDialog(game) {
      // Reset scroll and clear old content
      document.getElementById('gameDetailBody').scrollTop = 0;
      document.getElementById('comment-list').innerHTML = '<div class="empty">Loading reviews...</div>';
      document.getElementById('rating-form-container').innerHTML = '';
      const detailIcon = document.getElementById('detailIcon');
      const defaultIcon = "data:image/svg+xml;utf8,<svg viewBox='0 0 128 128' xmlns='http://www.w3.org/2000/svg'><path fill='currentColor' d='M 96.75,22.375 C 87.8,22.24 78.78,27.23 73.31,38.41 L 18.44,62.19 L 18.25,62.25 C 8.64,67.49 4,75.88 3.22,84.47 C 2.44,93.06 5.34,101.86 10.44,108.66 C 15.54,115.45 22.92,120.32 31.25,120.5 C 39.58,120.68 48.46,116.01 56.19,104.91 L 56.28,104.81 C 69.71,97.56 82.78,91.81 101.25,83.88 C 110.96,79.6 123.59,70.86 124.25,44.28 C 120.46,32.73 111,24.6 100.66,22.75 C 99.36,22.52 98.06,22.39 96.75,22.375 z'/><g fill='white'><path d='M48,52 h-8 v-8 h-8 v8 h-8 v8 h8 v8 h8 v-8 h8z'/><circle cx='80' cy='52' r='6'/><circle cx='94' cy='45' r='6'/></g></svg>";
      detailIcon.src = defaultIcon;

      // Populate basic info
      document.getElementById('detailTitle').textContent = game.title;
      document.getElementById('detailTitleHeader').textContent = game.title;
      document.getElementById('detailCategory').textContent = game.category;
      document.getElementById('detailVersion').textContent = game.version || 'N/A';
      document.getElementById('detailSize').textContent = game.size || 'N/A';
      document.getElementById('detailDesc').textContent = game.description || 'No description provided.';

      const ratingInfo = calculateRating(game);
      document.getElementById('detailRating').innerHTML = ratingInfo.avg > 0 ? `${ratingInfo.avg.toFixed(1)} ★` : 'N/A';
      document.getElementById('detailRatingCount').textContent = `${ratingInfo.count} ratings`;
      document.getElementById('detailDownloads').textContent = game.download_count || 0;

      // Show dialog immediately with text content
      gameDetailDlg.showModal();

      // Asynchronously load images
      createSignedImageUrl(game.img_url).then(url => detailIcon.src = url || defaultIcon);

      const galleryContainer = document.getElementById('screenshot-gallery');
      const screenshotContainer = document.getElementById('screenshot-container');
      screenshotContainer.innerHTML = `<div class="empty">Loading screenshots...</div>`;

      let screenshotPaths = game.screenshots;
      if (typeof screenshotPaths === 'string' && screenshotPaths.trim().startsWith('[')) {
        try { screenshotPaths = JSON.parse(screenshotPaths); } catch (e) { screenshotPaths = []; }
      }

      if (Array.isArray(screenshotPaths) && screenshotPaths.length > 0) {
          galleryContainer.style.display = 'block';
          const urlPromises = screenshotPaths.map(path => createSignedImageUrl(path));
          Promise.all(urlPromises).then(urls => {
            screenshotContainer.innerHTML = urls.map(url => `<img src="${url}" alt="game screenshot" loading="lazy"/>`).join('');
          });
      } else {
          galleryContainer.style.display = 'none';
          screenshotContainer.innerHTML = '';
      }

      // Setup download button with price and purchase logic
      const downloadBtn = document.getElementById('detailDownloadBtn');
      const coinIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width:1.1em; height:1.1em; vertical-align:-0.2em;" aria-hidden="true"><path d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M12,18c-3.31,0-6-2.69-6-6s2.69-6,6-6s6,2.69,6,6 S15.31,18,12,18z M12.5,13.5h-1v-3h1V13.5z M12.5,9.5h-1V8h1V9.5z"/></svg>`;
      const isPaid = game.price && game.price > 0;
      const originalButtonText = isPaid ? `Beli (${game.price} ${coinIconSvg})` : 'Download';
      downloadBtn.innerHTML = originalButtonText;

      downloadBtn.onclick = async (e) => {
        e.preventDefault();
        downloadBtn.textContent = 'Memproses...';
        downloadBtn.style.pointerEvents = 'none';

        try {
          // Paid Game Logic
          if (isPaid) {
            if (!currentUser) {
              loginDlg.showModal();
              throw new Error('Anda harus login untuk membeli game ini.');
            }
            if (!confirm(`Anda akan membeli ${game.title} seharga ${game.price} koin. Lanjutkan?`)) {
              throw new Error('Pembelian dibatalkan oleh pengguna.');
            }

            const { data, error } = await supabase.rpc('purchase_game', { game_id_to_purchase: game.id });
            if (error) { throw error; }

            alert(`Pembelian berhasil!`);
            await renderLoginState(currentUser); // Re-fetch profile to get latest coin balance

          // Free Game Logic
          } else {
            const { error } = await supabase.rpc('increment_download_count', { game_id_to_update: game.id });
            if (error) { throw error; }
          }

          // Common Success Logic (Download)
          const gameInCache = (window.__ALL_GAMES__ || []).find(g => g.id == game.id);
          if (gameInCache) {
            gameInCache.download_count = (gameInCache.download_count || 0) + 1;
            document.getElementById('detailDownloads').textContent = gameInCache.download_count;
          }

          const url = await resolveDownloadUrl(game);
          window.location.href = url;

        } catch (err) {
          // Only show alert if it's not a user cancellation
          if (err.message !== 'Pembelian dibatalkan oleh pengguna.') {
            alert('Gagal: ' + err.message);
          }
        } finally {
          // Reset button
          setTimeout(() => {
            downloadBtn.innerHTML = originalButtonText;
            downloadBtn.style.pointerEvents = 'auto';
          }, 500);
        }
      };

      // Setup share button
      const shareBtn = document.getElementById('detailShareBtn');
      shareBtn.onclick = async () => {
        const shareData = {
          title: `Download ${game.title} di RaVin Store`,
          text: `Cek ${game.title} di RaVin Store!`,
          url: `${window.location.origin}${window.location.pathname}?game=${game.id}`
        };
        try {
          if (navigator.share) {
            await navigator.share(shareData);
          } else {
            await navigator.clipboard.writeText(shareData.url);
            alert('Tautan berbagi telah disalin ke clipboard!');
          }
        } catch (err) {
          console.error('Share failed:', err);
          alert('Gagal membagikan. Silakan coba lagi.');
        }
      };

      // Fetch and render comments
      fetchComments(game.id).then(comments => renderComments(comments));

      // If user is logged in, show rating form
      if (currentUser) {
          supabase.from('ratings').select('rating').eq('game_id', game.id).eq('user_id', currentUser.id).single()
            .then(({ data }) => createRatingForm(game.id, data ? data.rating : 0));
      }
    }

    async function fetchGames(){
      const { data, error } = await supabase.from('games').select('*, ratings(rating)').order('created_at', { ascending:false });
      if(error){ console.error(error); return []; }
      return data;
    }

    async function renderGames(list, targetGrid = grid){
      if(!list || list.length===0){
        targetGrid.innerHTML = '';
        if (targetGrid === grid) {
          emptyState.style.display = 'block';
        }
        return;
      }
      if (targetGrid === grid) {
        emptyState.style.display = 'none';
      }
      targetGrid.innerHTML = `<div class="empty">Loading game images...</div>`;

      try {
        const urlPromises = list.map(g => createSignedImageUrl(g.img_url));
        const urls = await Promise.all(urlPromises);

        targetGrid.innerHTML = list.map((g, index) => {
          return gameCardTemplate(g, urls[index]);
        }).join('');
      } catch (error) {
        console.error("Error loading game images:", error);
        targetGrid.innerHTML = `<div class="empty">Error loading images. Please try again.</div>`;
      }
    }

    async function renderTrendingGames(allGames) {
      const trendingGrid = document.getElementById('trendingGrid');
      const sortedGames = [...allGames].sort((a, b) => {
        const countA = a.ratings ? a.ratings.length : 0;
        const countB = b.ratings ? b.ratings.length : 0;
        return countB - countA;
      });
      const topGames = sortedGames.slice(0, 5);
      await renderGames(topGames, trendingGrid);
    }

    async function loadGames(){
      const all = await fetchGames();
      window.__ALL_GAMES__ = all; // Cache all games
      await applyFilterAndSearch();
      await renderTrendingGames(all);

      // Handle deep links
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const gameId = urlParams.get('game');
        if (gameId) {
          const gameToOpen = all.find(g => g.id == gameId);
          if (gameToOpen) {
            openDetailDialog(gameToOpen);
          }
        }
      } catch(e) { console.error("Error handling deep link:", e); }
    }

    // ====== EVENT LISTENERS ======
    document.querySelector('.container').addEventListener('click', async (e) => {
        const card = e.target.closest('.card');
        if (!card) return;

        const gameId = card.dataset.gameId;
        if (!gameId) return;

        const game = (window.__ALL_GAMES__ || []).find(g => g.id == gameId);
        if (!game) return;

        openDetailDialog(game);
    });

    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const pills = Array.from(document.querySelectorAll('.pill'));
    const scanBtn = document.getElementById('scanBtn');
    const iconPreview = document.getElementById('iconPreview');
    const apkFileInput = document.getElementById('apkFile');
    let activeCat = 'all';

    function filterData(){
      const q = (searchInput.value||'').toLowerCase().trim();
      const src = window.__ALL_GAMES__ || [];
      return src.filter(g=>{
        const okCat = activeCat==='all' || (g.category||'').toLowerCase()===activeCat.toLowerCase();
        const txt = `${g.title||''} ${g.category||''} ${g.description||''}`.toLowerCase();
        const okSearch = !q || txt.includes(q);
        return okCat && okSearch;
      });
    }

    async function applyFilterAndSearch(){
      const filtered = filterData();
      await renderGames(filtered);
    }

    searchBtn.addEventListener('click', applyFilterAndSearch);
    searchInput.addEventListener('input', applyFilterAndSearch);
    pills.forEach(p=>{
      p.addEventListener('click', ()=>{
        pills.forEach(x=>x.classList.remove('active'));
        p.classList.add('active');
        activeCat = p.dataset.cat;
        applyFilterAndSearch();
      });
    });

    scanBtn.addEventListener('click', async () => {
      const apkFile = apkFileInput.files[0];
      if (!apkFile) {
        alert('Please select an APK file first.');
        return;
      }

      scanBtn.disabled = true;
      scanBtn.textContent = 'Scanning...';

      try {
        const zip = await JSZip.loadAsync(apkFile);
        const imageExtensions = ['.png', '.webp', '.jpg', '.jpeg'];
        const commonIconNames = ['ic_launcher.png', 'ic_launcher_round.png', 'app_icon.png', 'icon.png'];

        let imageFiles = [];
        zip.forEach((relativePath, file) => {
          const isImage = imageExtensions.some(ext => relativePath.toLowerCase().endsWith(ext));
          if (!file.dir && isImage && (relativePath.toLowerCase().startsWith('res/') || relativePath.toLowerCase().includes('mipmap'))) {
            imageFiles.push(file);
          }
        });

        if (imageFiles.length === 0) {
          throw new Error('No image files found in the APK\'s resource directories.');
        }

        let bestIconFile = null;

        // 1. Prioritize common icon names
        const commonIcons = imageFiles.filter(file => commonIconNames.some(name => file.name.toLowerCase().endsWith('/' + name)));

        if (commonIcons.length > 0) {
            // If common icons are found, pick the one with the largest uncompressed size
            let largestSize = 0;
            for(const file of commonIcons) {
                if (file._data.uncompressedSize > largestSize) {
                    largestSize = file._data.uncompressedSize;
                    bestIconFile = file;
                }
            }
        } else {
            // 2. Fallback: find the largest image file overall
            let largestSize = 0;
            for(const file of imageFiles) {
                 if (file._data.uncompressedSize > largestSize) {
                    largestSize = file._data.uncompressedSize;
                    bestIconFile = file;
                }
            }
        }

        if (!bestIconFile) {
          throw new Error('Could not find a suitable icon file in the APK.');
        }

        const iconBlob = await bestIconFile.async('blob');
        const iconFileExtension = bestIconFile.name.split('.').pop();
        extractedIconFile = new File([iconBlob], `icon.${iconFileExtension}`, { type: iconBlob.type });

        iconPreview.src = URL.createObjectURL(iconBlob);
        alert('Icon scanned successfully!');

      } catch (error) {
        alert(`Failed to scan icon: ${error.message}`);
        console.error(error);
      } finally {
        scanBtn.disabled = false;
        scanBtn.textContent = 'Scan from APK';
      }
    });

    const DEFAULT_ZIP_ICON_SVG = `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="64" height="64"><rect x="8" y="4" width="48" height="56" rx="8" ry="8" fill="%23a0aec0"/><path d="M20,4 L20,22 L44,22 L44,4z" fill="%23718096"/><rect x="20" y="4" width="4" height="18" fill="%23a0aec0"/><text x="32" y="46" font-family="sans-serif" font-size="18" fill="white" font-weight="bold" text-anchor="middle">ZIP</text></svg>`;
    const customIconRow = document.getElementById('customIconRow');
    const customIconFileInput = document.getElementById('customIconFile');
    const scanBtnHelp = document.getElementById('scanBtnHelp');

    apkFileInput.addEventListener('change', () => {
        const file = apkFileInput.files[0];
        if (!file) return;

        if (file.name.toLowerCase().endsWith('.zip')) {
            scanBtn.style.display = 'none';
            scanBtnHelp.style.display = 'none';
            customIconRow.style.display = 'block';
            iconPreview.src = DEFAULT_ZIP_ICON_SVG;
            extractedIconFile = null; // Clear any previously scanned icon
        } else { // Assuming .apk or other allowed types
            scanBtn.style.display = 'block';
            scanBtnHelp.style.display = 'block';
            customIconRow.style.display = 'none';
            iconPreview.src = 'game.png'; // Reset to default placeholder
            customIconFileInput.value = ''; // Clear custom icon input
        }
    });

    customIconFileInput.addEventListener('change', () => {
        const file = customIconFileInput.files[0];
        if (file) {
            iconPreview.src = URL.createObjectURL(file);
        } else {
            // If user cancels file selection, revert to default zip icon
            if(apkFileInput.files[0] && apkFileInput.files[0].name.toLowerCase().endsWith('.zip')) {
                iconPreview.src = DEFAULT_ZIP_ICON_SVG;
            }
        }
    });

    // ====== INISIALISASI ======
    (async function init(){
      await loadGames();
    })();
  </script>
</body>
</html>

